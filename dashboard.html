<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="/images/favicon.png" type="image/x-icon">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link
      rel="stylesheet"
      data-purpose="Layout StyleSheet"
      title="Web Awesome"
      href="/css/app-wa-86cd56275caec687041f80b17dc62e32.css?vsn=d"
    >

      <link
        rel="stylesheet"
        href="https://site-assets.fontawesome.com/releases/v6.7.2/css/all.css"
      >

      <link
        rel="stylesheet"
        href="https://site-assets.fontawesome.com/releases/v6.7.2/css/sharp-duotone-thin.css"
      >

      <link
        rel="stylesheet"
        href="https://site-assets.fontawesome.com/releases/v6.7.2/css/sharp-duotone-solid.css"
      >

      <link
        rel="stylesheet"
        href="https://site-assets.fontawesome.com/releases/v6.7.2/css/sharp-duotone-regular.css"
      >

      <link
        rel="stylesheet"
        href="https://site-assets.fontawesome.com/releases/v6.7.2/css/sharp-duotone-light.css"
      >

      <link
        rel="stylesheet"
        href="https://site-assets.fontawesome.com/releases/v6.7.2/css/sharp-thin.css"
      >

      <link
        rel="stylesheet"
        href="https://site-assets.fontawesome.com/releases/v6.7.2/css/sharp-solid.css"
      >

      <link
        rel="stylesheet"
        href="https://site-assets.fontawesome.com/releases/v6.7.2/css/sharp-regular.css"
      >

      <link
        rel="stylesheet"
        href="https://site-assets.fontawesome.com/releases/v6.7.2/css/sharp-light.css"
      >

      <link
        rel="stylesheet"
        href="https://site-assets.fontawesome.com/releases/v6.7.2/css/duotone-thin.css"
      >

      <link
        rel="stylesheet"
        href="https://site-assets.fontawesome.com/releases/v6.7.2/css/duotone-regular.css"
      >

      <link
        rel="stylesheet"
        href="https://site-assets.fontawesome.com/releases/v6.7.2/css/duotone-light.css"
      >


    <title>Student Dashboard</title>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .gradient-card {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .7;
            }
        }
        .sidebar {
            width: 16rem;
            position: fixed;
            top: 4rem;
            height: calc(100% - 7rem);
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
            margin: 1.25rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .sidebar.collapsed {
            width: 4rem;
        }
        .main-content {
            margin-left: 16rem;
            margin-top: 4rem;
            transition: all 0.3s ease;
        }
        .main-content.collapsed {
            margin-left: 4rem;
        }
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 20;
            background-color: white;
        }
        .toggle-btn {
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 11;
            transition: all 0.3s ease;
        }
        .toggle-btn:hover {
            background-color: #f3f4f6;
        }
        
        /* Hamburger menu styles */
        .hamburger-menu {
            display: none;
            cursor: pointer;
            padding: 10px;
        }
        
        .hamburger-icon {
            width: 24px;
            height: 20px;
            position: relative;
            margin: 0 auto;
            transform: rotate(0deg);
            transition: .5s ease-in-out;
        }
        
        .hamburger-icon span {
            display: block;
            position: absolute;
            height: 3px;
            width: 100%;
            background: #6366f1;
            border-radius: 3px;
            opacity: 1;
            left: 0;
            transform: rotate(0deg);
            transition: .25s ease-in-out;
        }
        
        .hamburger-icon span:nth-child(1) {
            top: 0px;
        }
        
        .hamburger-icon span:nth-child(2) {
            top: 8px;
        }
        
        .hamburger-icon span:nth-child(3) {
            top: 16px;
        }
        
        .hamburger-icon.open span:nth-child(1) {
            top: 8px;
            transform: rotate(135deg);
        }
        
        .hamburger-icon.open span:nth-child(2) {
            opacity: 0;
            left: -60px;
        }
        
        .hamburger-icon.open span:nth-child(3) {
            top: 8px;
            transform: rotate(-135deg);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .hamburger-menu {
                display: block;
            }
            
            .sidebar {
                width: 75%;
                max-width: 300px;
                height: 100%;
                position: fixed;
                top: 0;
                left: 0;
                margin: 0;
                border-radius: 0;
                transform: translateX(-100%);
                z-index: 50;
                transition: transform 0.3s ease;
                padding-top: 4rem; /* Add padding to prevent content from being hidden behind navbar */
            }
            .sidebar.collapsed {
                transform: translateX(0);
                width: 75%;
                max-width: 300px;
            }
            .main-content {
                margin-left: 0 !important;
                width: 100%;
            }
            .toggle-btn {
                display: none; /* Hide the regular toggle button on mobile */
            }
            .nav-bar {
                z-index: 51;
            }
            /* Add overlay when sidebar is open */
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 49;
                transition: opacity 0.3s ease;
                opacity: 0;
            }
            .sidebar-overlay.active {
                display: block;
                opacity: 1;
            }
            /* Fix sidebar menu items for mobile */
            .sidebar-text {
                display: block !important;
            }
        }
        
        /* Small mobile devices */
        @media (max-width: 480px) {
            .sidebar {
                width: 85%;
            }
            .sidebar.collapsed {
                width: 85%;
            }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        .modal-content {
            position: relative;
            background-color: white;
            margin: 2rem auto;
            padding: 2rem;
            width: 90%;
            max-width: 1200px;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            color: #6B7280;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-modal:hover {
            color: #374151;
        }
        .subject-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .subject-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .grade-slider {
            width: 150px;
            height: 8px;
            -webkit-appearance: none;
            background: linear-gradient(to right, #ef4444, #f59e0b, #84cc16, #10b981, #3b82f6, #6366f1, #8b5cf6);
            border-radius: 10px;
            outline: none;
        }
        .grade-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            border: 2px solid #6366f1;
            cursor: pointer;
        }
        .grade-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            border: 2px solid #6366f1;
            cursor: pointer;
        }
        
        /* Attendance Circle Styles */
        .attendance-circle {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .attendance-circle svg {
            transform: rotate(-90deg);
            overflow: visible;
        }
        
        .attendance-circle .circle-bg {
            stroke-linecap: round;
        }
        
        .attendance-circle .circle {
            stroke-linecap: round;
            stroke-dashoffset: 0;
        }
        
        .attendance-circle .percentage {
            transform: rotate(90deg);
            font-family: 'Poppins', sans-serif;
        }
        
        .attendance-circle text {
            text-anchor: middle;
            dominant-baseline: central;
            paint-order: stroke;
            stroke: rgba(255, 255, 255, 0.5);
            stroke-width: 0.5px;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .grade-D { color: #ef4444; }
        .grade-C { color: #f59e0b; }
        .grade-B { color: #84cc16; }
        .grade-B\\+ { color: #10b981; }
        .grade-A { color: #3b82f6; }
        .grade-A\\+ { color: #6366f1; }
        .grade-O { color: #8b5cf6; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Assignments Modal -->
    <div id="assignmentsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Assignment Marks</h2>
                <p class="mt-1 text-sm text-gray-500">View your assignment marks across all subjects</p>
            </div>
            <div id="assignmentsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Assignment cards will be inserted here -->
            </div>
        </div>
    </div>
    <div id="reportGlitchesModal" class="modal">
        <div class="modal-content max-w-2xl">
            <span class="close-modal" data-modal="reportGlitchesModal">&times;</span>
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Report Glitches or Suggest Features</h2>
                <p class="mt-1 text-sm text-gray-500">Help us improve by reporting any issues you encounter or suggest new features</p>
            </div>
            <form id="glitchReportForm" class="space-y-6">
                <div>
                    <label for="glitchType" class="block text-sm font-medium text-gray-700">Type of Issue</label>
                    <select id="glitchType" name="glitchType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="" disabled selected>Select an issue type</option>
                        <option value="ui">UI/Display Issue</option>
                        <option value="functionality">Functionality Issue</option>
                        <option value="performance">Performance Issue</option>
                        <option value="data">Data Accuracy Issue</option>
                        <option value="feature">Feature Suggestion</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="glitchDescription" class="block text-sm font-medium text-gray-700">Describe in detail</label>
                    <textarea id="glitchDescription" name="glitchDescription" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Please provide as much detail as possible..."></textarea>
                </div>

                <div class=" px-4 py-3 text-center sm:px-6">
                    <button type="submit" class="inline-flex justify-center py-3 px-10 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Submit Report
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Announcements Modal -->
    <div id="announcementsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" data-modal="announcementsModal">&times;</span>
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Announcements</h2>
                <p class="mt-1 text-sm text-gray-500">View important announcements and updates</p>
            </div>
            <div id="announcementsContainer" class="space-y-4">
                <!-- Announcements will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Rank Check Modal -->
    <div id="rankCheckModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" data-modal="rankCheckModal">&times;</span>
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Check Your Rank</h2>
                <p class="mt-1 text-sm text-gray-500">Enter your registration number to view your rank</p>
            </div>
            <div class="max-w-md mx-auto">
                <form id="rankCheckForm" class="space-y-6">
                    <div>
                        <label for="rankRegNo" class="block text-sm font-medium text-gray-700">Registration Number</label>
                        <div class="mt-1">
                            <input type="text" name="rankRegNo" id="rankRegNo" required
                                class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                placeholder="Enter your registration number">
                        </div>
                    </div>
                    <div class="mt-4 bg-indigo-50 border-l-4 border-indigo-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-indigo-500"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-indigo-700">
                                    Rank data is based on the following:
                                    <ul class="list-disc list-inside text-sm text-indigo-700 mt-2">
                                        <li>2026 Batch: till 4th Semester</li>
                                        <li>2027 Batch: till 3rd Semester</li>
                                        <li>2028 Batch: till 1st Semester</li>
                                    </ul>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <button type="submit"
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Check Rank
                        </button>
                    </div>
                </form>
                <div id="rankResult" class="mt-6 hidden">
                    <div class="bg-gradient-to-br from-indigo-50 to-white shadow-lg rounded-xl p-6">
                        <div class="flex items-center mb-4">
                            <div class="flex-shrink-0 bg-indigo-600 rounded-full p-3">
                                <i class="fas fa-user-graduate text-white text-2xl"></i>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-xl font-bold text-gray-900" id="studentName">-</h3>
                                <p class="text-sm text-gray-500" id="studentCourse">-</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <div class="text-xs text-gray-400">Registration No.</div>
                                <div class="font-semibold text-gray-800" id="studentRegNo">-</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-400">State</div>
                                <div class="font-semibold text-gray-800" id="studentState">-</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-400">CGPA</div>
                                <div class="font-semibold text-indigo-700" id="studentCGPA">-</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-400">Gender</div>
                                <div class="font-semibold text-gray-800" id="studentGender">-</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-400">Batch Year</div>
                                <div class="font-semibold text-gray-800" id="studentBatch">-</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-400">Country</div>
                                <div class="font-semibold text-gray-800" id="studentCountry">-</div>
                            </div>
                        </div>
                        <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div class="bg-white rounded-lg shadow p-4 text-center">
                                <div class="text-xs text-gray-400">Rank</div>
                                <div class="text-2xl font-bold text-indigo-700" id="studentRank">-</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-4 text-center">
                                <div class="text-xs text-gray-400">You are in top</div>
                                <div class="text-2xl font-bold text-green-600" id="studentPercentile">-</div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-4 text-center">
                                <div class="text-xs text-gray-400">Total Students</div>
                                <div class="text-2xl font-bold text-gray-800" id="studentTotal">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="videoModal" class="modal">
        <div class="modal-content bg-white p-4" style="max-width: 380px; width: 80%;">
            <span class="close-modal" id="closeVideoModal">&times;</span>
            <div class="text-center mb-3">
                <h3 class="text-lg font-bold text-red-600">No Student Found</h3>
                <p class="text-gray-600 mt-1 text-sm">We couldn't find any student with the provided registration number.</p>
            </div>
            <div class="video-container bg-white rounded-lg overflow-hidden shadow-md mx-auto" style="max-width: 400px;">
                <video id="notFoundVideo" width="100%" height="auto" controls style="max-height: 200px;">
                    <source src="https://files.catbox.moe/kwykzn.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        </div>
    </div>

    <!-- Messages Modal -->
    <div id="messagesModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" data-modal="messagesModal">&times;</span>
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900">My Messages</h2>
                <p class="mt-1 text-sm text-gray-500">View your personal messages and notifications</p>
            </div>
            <div id="messagesContainer" class="space-y-4">
                <!-- Messages will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Attendance Modal -->
    <div id="attendanceModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" data-modal="attendanceModal">&times;</span>
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Attendance</h2>
                <p class="mt-1 text-sm text-gray-500">View your attendance records for all courses</p>
            </div>
            <div id="attendanceContainer" class="space-y-4">
                <!-- Attendance records will be inserted here -->
            </div>
        </div>
    </div>

    <!-- TGPA Calculator Modal -->
    <div id="tgpaCalculatorModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" data-modal="tgpaCalculatorModal">&times;</span>
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Calculate TGPA</h2>
                <p class="mt-1 text-sm text-gray-500">Calculate your Term Grade Point Average</p>
            </div>
            <!-- Tabs -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="currentSemTab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">
                        Current Semester
                    </button>
                    <button id="otherSemTab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Other Semester
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="currentSemContainer" class="mt-4">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-4">Select grades for each subject to calculate your TGPA.</p>
                        <div id="subjectGradesContainer" class="space-y-6">
                            <!-- Subject grades will be inserted here -->
                        </div>
                    </div>
                    <div class="mt-8">
                        <button id="calculateTgpaBtn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Calculate TGPA
                        </button>
                    </div>
                    <div id="tgpaResult" class="mt-6 hidden">
                        <div class="bg-gradient-to-br from-indigo-50 to-white shadow-lg rounded-xl p-6 text-center">
                            <div class="text-xl font-bold text-gray-900 mb-2">Your TGPA</div>
                            <div class="text-4xl font-bold text-indigo-600 mb-2" id="calculatedTgpa">0.00</div>
                            <div class="text-sm text-indigo-500" id="tgpaMessage"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="otherSemContainer" class="mt-4 hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="mb-6">
                        <label for="numSubjects" class="block text-sm font-medium text-gray-700">Number of Subjects</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <input type="number" name="numSubjects" id="numSubjects" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-l-md focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border-gray-300" placeholder="e.g., 5">
                            <button id="generateFieldsBtn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">
                                Generate
                            </button>
                        </div>
                    </div>
                    <div id="otherSemGradesContainer" class="space-y-6">
                        <!-- Dynamic fields will be inserted here -->
                    </div>
                    <div id="otherSemCalculateSection" class="mt-8 hidden">
                        <button id="calculateOtherSemTgpaBtn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Calculate TGPA
                        </button>
                    </div>
                    <div id="otherSemTgpaResult" class="mt-6 hidden">
                        <div class="bg-gradient-to-br from-indigo-50 to-white shadow-lg rounded-xl p-6 text-center">
                            <div class="text-xl font-bold text-gray-900 mb-2">Your TGPA</div>
                            <div class="text-4xl font-bold text-indigo-600 mb-2" id="otherCalculatedTgpa">0.00</div>
                            <div class="text-sm text-indigo-500" id="otherTgpaMessage"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Term Wise Marks Modal -->
<div id="termWiseMarksModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" data-modal="termWiseMarksModal">&times;</span>
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Term Wise Marks</h2>
            <p class="mt-1 text-sm text-gray-500">View your detailed marks breakdown for all courses</p>
        </div>
        <div id="termWiseMarksContainer" class="space-y-6">
            <!-- Term wise marks data will be inserted here -->
        </div>
    </div>
</div>

<!-- About Developer Modal -->
<div id="aboutDeveloperModal" class="modal">
    <div class="modal-content max-w-4xl">
        <span class="close-modal" data-modal="aboutDeveloperModal">&times;</span>
        
        <div class="flex flex-col md:flex-row gap-8">
            <!-- Left side - Profile -->
            <div class="w-full md:w-1/3 flex flex-col items-center">
                <div class="relative group">
                    <div class="w-full h-full rounded-full overflow-hidden border-4 border-indigo-500 shadow-lg bg-[#ffcd2d] flex items-center justify-center">
                        <img src="#" alt="Developer" class="w-full h-full object-cover transform translate-y-8 -translate-x-4">
                    </div>
                    <div class="absolute inset-0 rounded-full opacity-0 transition-opacity duration-300"></div>
                </div>
                
                
                <h3 class="text-2xl font-bold mt-4 bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">UMZ</h3>
                <!-- <p class="text-gray-500 text-sm">✨ Full Stack Developer ✨</p> -->
                
                <div class="flex space-x-3 mt-4">
                    <a href="https://github.com" target="_blank" class="text-gray-700 hover:text-indigo-600 transition-colors">
                        <i class="fab fa-github text-xl"></i>
                    </a>
                    <a href="https://linkedin.com" target="_blank" class="text-gray-700 hover:text-indigo-600 transition-colors">
                        <i class="fab fa-linkedin text-xl"></i>
                    </a>
                    <a href="https://twitter.com" target="_blank" class="text-gray-700 hover:text-indigo-600 transition-colors">
                        <i class="fab fa-twitter text-xl"></i>
                    </a>
                    <a href="mailto:dev@example.com" class="text-gray-700 hover:text-indigo-600 transition-colors">
                        <i class="fas fa-envelope text-xl"></i>
                    </a>
                </div>
            </div>
            
            <!-- Right side - Content -->
            <div class="w-full md:w-2/3">
                <h2 class="text-3xl font-extrabold mb-6">
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">About the Dev</span>
                    <span class="text-base align-text-top ml-2 bg-indigo-100 text-indigo-800 py-0.5 px-2 rounded-full">v2.0</span>
                </h2>
                
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-indigo-500 hover:shadow-md transition-shadow">
                        <h3 class="font-bold text-lg flex items-center">
                            <span class="bg-indigo-100 text-indigo-800 p-1 rounded mr-2">
                                <i class="fas fa-rocket"></i>
                            </span>
                            The Vibe
                        </h3>
                        <p class="mt-2 text-gray-600">Hey there! 👋 I'm that dev who turns caffeine into code and dreams into digital reality. When I'm not debugging at 3AM, I'm probably thinking about how to make this platform even more 🔥 for you!</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500 hover:shadow-md transition-shadow">
                        <h3 class="font-bold text-lg flex items-center">
                            <span class="bg-purple-100 text-purple-800 p-1 rounded mr-2">
                                <i class="fas fa-code"></i>
                            </span>
                            Tech Stack
                        </h3>
                        <div class="mt-3 flex flex-wrap gap-2">
                            <span class="px-2 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-800">Python</span>
                            <span class="px-2 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-800">Flask</span>
                            <span class="px-2 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-800">JavaScript</span>
                            <span class="px-2 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-800">Tailwind CSS</span>
                            <span class="px-2 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-800">Supabase</span>
                            <span class="px-2 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-800">HTML/CSS</span>
                            <span class="px-2 py-1 bg-indigo-100 rounded-full text-xs font-medium text-indigo-800">+ more</span>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500 hover:shadow-md transition-shadow">
                        <h3 class="font-bold text-lg flex items-center">
                            <span class="bg-blue-100 text-blue-800 p-1 rounded mr-2">
                                <i class="fas fa-lightbulb"></i>
                            </span>
                            Fun Facts
                        </h3>
                        <ul class="mt-2 space-y-2 text-gray-600">
                            <li class="flex items-start">
                                <span class="text-indigo-500 mr-2">✦</span>
                                Built this entire system in just two weeks while binging 90s sitcoms
                            </li>
                            <li class="flex items-start">
                                <span class="text-indigo-500 mr-2">✦</span>
                                Can type 97 WPM but still uses Google to check basic syntax <span class="text-indigo-800"><a href="#" target="_blank" rel="noopener noreferrer">{Proof}</a></span>
                            </li>
                            <li class="flex items-start">
                                <span class="text-indigo-500 mr-2">✦</span>
                                Believes dark mode is superior but built this in light mode for you
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="mt-6 text-center">
                    <button class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg shadow-md hover:from-indigo-700 hover:to-purple-700 transition-all transform hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-heart mr-2"></i> Leave Feedback
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="min-h-screen flex">
        <!-- Sidebar Overlay -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>
        
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar mt-5 rounded-lg">
            <div class="flex flex-col ">
                <!-- Sidebar Menu -->
                <nav class="flex-1 p-4">
                    <div class="space-y-3">
                          <a href="#" id="announcementsBtn" class="flex items-center p-3 md:p-3 py-4 rounded-lg hover:bg-indigo-50 text-gray-700 hover:text-indigo-600 transition-colors">
                             <div class="w-8 flex-shrink-0">
                                <i class="fa-duotone fa-thin fa-bullhorn text-indigo-600 text-lg"></i>
                             </div>
                             <span class="sidebar-text font-medium ml-3">Announcements</span>
                        </a>
                          <a href="#" id="messagesBtn" class="flex items-center p-3 md:p-3 py-4 rounded-lg hover:bg-indigo-50 text-gray-700 hover:text-indigo-600 transition-colors">
                             <div class="w-8 flex-shrink-0">
                                <i class="fa-duotone fa-thin fa-envelopes text-indigo-600 text-lg"></i>
                             </div>
                             <span class="sidebar-text font-medium ml-3">My Messages</span>
                        </a>

                          <a href="#" id="assignmentsBtn" class="flex items-center p-3 md:p-3 py-4 rounded-lg hover:bg-indigo-50 text-gray-700 hover:text-indigo-600 transition-colors">
                             <div class="w-8 flex-shrink-0">
                                <i class="fa-duotone fa-thin fa-tasks text-indigo-600 text-lg"></i>
                             </div>
                             <span class="sidebar-text font-medium ml-3">Assignments</span>
                        </a>
                        
                          <a href="#" id="term_wise_marks" class="flex items-center p-3 md:p-3 py-4 rounded-lg hover:bg-indigo-50 text-gray-700 hover:text-indigo-600 transition-colors">
                            <div class="w-8 flex-shrink-0">
                               <i class="fa-duotone fa-thin fa-file-chart-column text-indigo-600 text-lg"></i>
                            </div>
                            <span class="sidebar-text font-medium ml-3">View Marks</span>
                        </a>
                          <a href="#" id="attendanceBtn" class="flex items-center p-3 md:p-3 py-4 rounded-lg hover:bg-indigo-50 text-gray-700 hover:text-indigo-600 transition-colors">
                             <div class="w-8 flex-shrink-0">
                                <i class="fa-duotone fa-thin fa-calendar-check text-indigo-600 text-lg"></i>
                             </div>
                             <span class="sidebar-text font-medium ml-3">Attendance</span>
                        </a>
                          <a href="#" id="rankCheckBtn" class="flex items-center p-3 md:p-3 py-4 rounded-lg hover:bg-indigo-50 text-gray-700 hover:text-indigo-600 transition-colors">
                             <div class="w-8 flex-shrink-0">
                                <i class="fa-duotone fa-thin fa-trophy text-indigo-600 text-lg"></i>
                             </div>
                             <span class="sidebar-text font-medium ml-3">Check Your Rank</span>
                        </a>

                        <a href="#" id="tgpaCalculatorBtn" class="flex items-center p-3 md:p-3 py-4 rounded-lg hover:bg-indigo-50 text-gray-700 hover:text-indigo-600 transition-colors">
                             <div class="w-8 flex-shrink-0">
                                <i class="fa-duotone fa-thin fa-calculator text-indigo-600 text-lg"></i>
                             </div>
                             <span class="sidebar-text font-medium ml-3">Calculate TGPA</span>
                        </a>

                        <a href="#" id="reportGlitchesBtn" class="flex items-center p-3 md:p-3 py-4 rounded-lg hover:bg-indigo-50 text-gray-700 hover:text-indigo-600 transition-colors">
                            <div class="w-8 flex-shrink-0">
                                <i class="fa-duotone fa-thin fa-bug text-indigo-600 text-lg"></i>
                            </div>
                            <span class="sidebar-text font-medium ml-3">Report Glitches / Suggest features</span>
                        </a>
                        
                        <a href="#" id="aboutDeveloperBtn" class="flex items-center p-3 md:p-3 py-4 rounded-lg hover:bg-indigo-50 text-gray-700 hover:text-indigo-600 transition-colors">
                            <div class="w-8 flex-shrink-0">
                                <i class="fa-duotone fa-thin fa-user-astronaut text-indigo-600 text-lg"></i>
                            </div>
                            <span class="sidebar-text font-medium ml-3">About Developer</span>
                        </a>
                    </div>
                </nav>
                <button id="toggleSidebar" class="toggle-btn">
                    <i id="toggleIcon" class="fas fa-angle-left text-indigo-600 text-sm"></i>
                </button>
            </div>
        </div>

        <!-- Main Content Wrapper -->
        <div id="mainContent" class="main-content flex-1">
            <!-- Navigation -->
            <nav class="nav-bar bg-white shadow-sm mx-2 md:ml-5 md:mr-24 rounded-lg mt-2">
                <div class="max-w-7xl mx-auto px-2 sm:px-4 md:px-6 lg:px-8">
                    <div class="flex justify-between h-16">
                        <div class="flex items-center">
                            <!-- Hamburger Menu for Mobile -->
                            <div class="hamburger-menu mr-2" id="hamburgerMenu">
                                <div class="hamburger-icon">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                            <div class="flex-shrink-0 flex items-center">
                                <img src="/images/navbarLogo.png" alt="UMz Logo" class="h-24 md:h-40 w-auto mr-2">
                                <!-- <span class="font-bold text-xl text-gray-800">Student Portal</span> -->
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div class="relative">
                                <div id="profileDropdownToggle" class="flex items-center space-x-2 cursor-pointer">
                                    <!-- <span id="studentName" class="text-sm font-medium text-gray-700">Loading...</span> -->
                                    <div id="profilePic" class="h-8 w-8 rounded-full bg-indigo-600 flex items-center justify-center uppercase text-white font-bold opacity-70">
                                        <span id="firstLetter"></span>
                                    </div>
                                    <i class="fa-duotone fa-thin fa-angle-down"></i>
                                </div>
                                <div id="logoutDropdown" class="absolute flex items-center justify-center right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20  hover:bg-gray-100 hidden">
                                    <button id="logoutBtn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</button>
                                    <i class="fa-duotone fa-thin fa-sign-out-alt text-black mr-2"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 -mt-7">
                <!-- Student Info Section -->
                <div class="px-4 py-6 sm:px-0">
                    <div class="bg-white overflow-hidden shadow rounded-lg divide-y divide-gray-200">
                        <div class="px-4 py-5 sm:px-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Student Information</h3>
                            <p class="mt-1 max-w-2xl text-sm text-gray-500">Personal details and academic information.</p>
                        </div>
                        <div class="px-4 py-5 sm:p-6">
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                                <div class="sm:col-span-3">
                                    <dt class="text-sm font-medium text-gray-500">Full name</dt>
                                    <dd id="fullName" class="mt-1 text-sm text-gray-900">Loading...</dd>
                                </div>
                                <div class="sm:col-span-3">
                                    <dt class="text-sm font-medium text-gray-500">Registration Number</dt>
                                    <dd id="regNo" class="mt-1 text-sm text-gray-900">Loading...</dd>
                                </div>
                                <!-- <div class="sm:col-span-3">
                                    <dt class="text-sm font-medium text-gray-500">Email address</dt>
                                    <dd id="email" class="mt-1 text-sm text-gray-900">Loading...</dd>
                                </div> -->
                                <div class="sm:col-span-3">
                                    <dt class="text-sm font-medium text-gray-500">Program</dt>
                                    <dd id="program" class="mt-1 text-sm text-gray-900">Loading...</dd>
                                </div>
                                <div class="sm:col-span-3">
                                    <dt class="text-sm font-medium text-gray-500">Section</dt>
                                    <dd id="section" class="mt-1 text-sm text-gray-900">Loading...</dd>
                                </div>
                                <div class="sm:col-span-3">
                                    <dt class="text-sm font-medium text-gray-500">Date of Birth</dt>
                                    <dd id="dateOfBirth" class="mt-1 text-sm text-gray-900">Loading...</dd>
                                </div>
                                <div class="sm:col-span-3">
                                    <dt class="text-sm font-medium text-gray-500">Aggregated Attendance</dt>
                                    <dd id="aggAttendance" class="mt-1 text-sm text-gray-900">Loading...</dd>
                                </div>
                                <div class="sm:col-span-3">
                                    <dt class="text-sm font-medium text-gray-500">Roll Number</dt>
                                    <dd id="rollNumber" class="mt-1 text-sm text-gray-900">Loading...</dd>
                                </div>
                                <div class="sm:col-span-3">
                                    <dt class="text-sm font-medium text-gray-500">Pending Fee</dt>
                                    <dd id="pendingFee" class="mt-1 text-sm text-gray-900">Loading...</dd>
                                </div>
                                <!-- <div class="sm:col-span-3">
                                    <dt class="text-sm font-medium text-gray-500">Encrypted DOB</dt>
                                    <dd id="encryptedDob" class="mt-1 text-sm text-gray-900">Loading...</dd>
                                </div>
                                <div class="sm:col-span-3">
                                    <dt class="text-sm font-medium text-gray-500">Student UID</dt>
                                    <dd id="studentUid" class="mt-1 text-sm text-gray-900">Loading...</dd>
                                </div> -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="mt-8 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-3 px-4 sm:px-0">
                    <!-- CGPA Card -->
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-indigo-500 rounded-md p-3">
                                    <i class="fas fa-chart-line text-white"></i>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dt class="text-sm font-medium text-gray-500 truncate">CGPA</dt>
                                    <dd id="cgpa" class="flex items-baseline">
                                        <div class="text-2xl font-semibold text-gray-900">Loading...</div>
                                    </dd>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Credits Card -->
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-purple-500 rounded-md p-3">
                                    <i class="fas fa-graduation-cap text-white"></i>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dt class="text-sm font-medium text-gray-500 truncate">Total Credits</dt>
                                    <dd id="totalCredits" class="flex items-baseline">
                                        <div class="text-2xl font-semibold text-gray-900">Loading...</div>
                                    </dd>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Term Card -->
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-blue-500 rounded-md p-3">
                                    <i class="fas fa-chart-pie text-white"></i>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dt class="text-sm font-medium text-gray-500 truncate">Grade Distribution</dt>
                                    <dd id="gradeCounts" class="mt-2 flex flex-wrap gap-2">
                                        <!-- Grade counts will be inserted here -->
                                    </dd>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Term-wise TGPA Section -->
                <div class="mt-8 px-4 sm:px-0">
                    <div class="bg-white shadow overflow-hidden sm:rounded-md">
                        <div class="flex justify-between px-4 py-5 border-b border-gray-200 sm:px-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Term-wise TGPA</h3>
                            <button id="toggleGraphBtn" class="mb-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Graphical Analysis</button>
                        </div>
                        <ul id="tgpaList" class="divide-y divide-gray-200">
                            <li class="px-4 py-4 sm:px-6 animate-pulse">
                                <div class="flex items-center justify-between">
                                    <p class="text-sm font-medium text-indigo-600 truncate">Loading term data...</p>
                                </div>
                            </li>
                        </ul>
                        <div class="p-4">
                            <div id="tgpaGraphContainer" style="display: none;">
                                <!-- Tabs for different chart types -->
                                <div class="mb-6 border-b border-gray-200">
                                    <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="chartTabs" role="tablist">
                                        <li class="mr-2" role="presentation">
                                            <button class="inline-block p-4 border-b-2 border-indigo-600 rounded-t-lg active" id="tgpa-tab" data-tab="tgpa-chart" type="button" role="tab" aria-selected="true">TGPA</button>
                                        </li>
                                        <li class="mr-2" role="presentation">
                                            <button class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:border-gray-300" id="ca-tab" data-tab="ca-chart" type="button" role="tab" aria-selected="false">Continuous Assessment</button>
                                        </li>
                                        <li class="mr-2" role="presentation">
                                            <button class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:border-gray-300" id="midterm-tab" data-tab="midterm-chart" type="button" role="tab" aria-selected="false">Midterm</button>
                                        </li>
                                        <li class="mr-2" role="presentation">
                                            <button class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:border-gray-300" id="endterm-theory-tab" data-tab="endterm-theory-chart" type="button" role="tab" aria-selected="false">End Term Theory</button>
                                        </li>
                                        <li role="presentation">
                                            <button class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:border-gray-300" id="endterm-practical-tab" data-tab="endterm-practical-chart" type="button" role="tab" aria-selected="false">End Term Practical</button>
                                        </li>
                                    </ul>
                                </div>
                                
                                <!-- Chart containers -->
                                <div id="chartTabContent">
                                    <div class="block" id="tgpa-chart" role="tabpanel" aria-labelledby="tgpa-tab">
                                <canvas id="tgpaChart"></canvas>
                            </div>
                                    <div class="hidden" id="ca-chart" role="tabpanel" aria-labelledby="ca-tab">
                                        <canvas id="caChart"></canvas>
                        </div>
                                    <div class="hidden" id="midterm-chart" role="tabpanel" aria-labelledby="midterm-tab">
                                        <canvas id="midtermChart"></canvas>
                                    </div>
                                    <div class="hidden" id="endterm-theory-chart" role="tabpanel" aria-labelledby="endterm-theory-tab">
                                        <canvas id="endtermTheoryChart"></canvas>
                                    </div>
                                    <div class="hidden" id="endterm-practical-chart" role="tabpanel" aria-labelledby="endterm-practical-tab">
                                        <canvas id="endtermPracticalChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Term Details Section -->
                                <div class="mt-8 pt-6 border-t border-gray-200" hidden>
                                    <h4 class="text-lg font-medium text-gray-900 mb-4">Term Details</h4>
                                    <div id="termDetailsAccordion" class="space-y-4">
                                        <!-- Term details will be inserted here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subject Grades Section -->
                <div class="mt-8 px-4 sm:px-0 pb-12">
                    <div class="bg-white shadow-lg rounded-xl overflow-hidden border border-gray-100">
                        <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-indigo-50 to-purple-50">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800">Course Performance</h2>
                                <div class="flex space-x-2">
                                    <button id="viewToggleBtn" class="px-3 py-1.5 bg-white text-indigo-600 rounded-md shadow-sm text-sm font-medium hover:bg-indigo-50 transition-colors border border-indigo-100 flex items-center">
                                        <i class="fas fa-th-large mr-1.5"></i>
                                        <span id="viewToggleText">Card View</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Table View (Default) -->
                        <div id="tableView" class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Credits</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th>
                                    </tr>
                                </thead>
                                <tbody id="gradesTableBody" class="bg-white divide-y divide-gray-200">
                                    <tr class="animate-pulse">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Card View (Hidden by default) -->
                        <div id="cardView" class="hidden p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Cards will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; transform: translateY(10px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                    
                    @keyframes scaleIn {
                        from { transform: scale(0.95); opacity: 0; }
                        to { transform: scale(1); opacity: 1; }
                    }
                    
                    @keyframes shimmer {
                        0% { background-position: -200% 0; }
                        100% { background-position: 200% 0; }
                    }
                    
                    .course-card {
                        animation: scaleIn 0.4s ease-out forwards;
                        transform-origin: center;
                        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                        border: 1px solid #f3f4f6;
                        height: 160px;
                    }
                    
                    /* Removing the colorful top border
                    .course-card::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 4px;
                        background: linear-gradient(90deg, #6366f1, #8b5cf6, #d946ef);
                    } */
                    
                    .course-card:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
                    }
                    
                    .grade-badge {
                        width: 36px;
                        height: 36px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 4px;
                        font-weight: medium;
                        font-size: 0.9rem;
                        box-shadow: none;
                        transition: all 0.3s ease;
                    }
                    
                    .course-card:hover .grade-badge {
                        transform: none;
                    }
                    
                    .credit-pill {
                        background: #f9fafb;
                        border: 1px solid #f3f4f6;
                        transition: all 0.3s ease;
                    }
                    
                    .course-card:hover .credit-pill {
                        background: #f3f4f6;
                    }
                    
                    .shimmer-bg {
                        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
                        background-size: 200% 100%;
                        animation: shimmer 1.5s infinite;
                    }
                    
                    .table-row-animate {
                        animation: fadeIn 0.5s ease-out forwards;
                    }
                    
                    .table-row-animate:nth-child(1) { animation-delay: 0.1s; }
                    .table-row-animate:nth-child(2) { animation-delay: 0.2s; }
                    .table-row-animate:nth-child(3) { animation-delay: 0.3s; }
                    .table-row-animate:nth-child(4) { animation-delay: 0.4s; }
                    .table-row-animate:nth-child(5) { animation-delay: 0.5s; }
                    .table-row-animate:nth-child(6) { animation-delay: 0.6s; }
                    .table-row-animate:nth-child(7) { animation-delay: 0.7s; }
                    .table-row-animate:nth-child(8) { animation-delay: 0.8s; }
                    .table-row-animate:nth-child(9) { animation-delay: 0.9s; }
                    .table-row-animate:nth-child(10) { animation-delay: 1.0s; }
                    
                    .card-animate:nth-child(1) { animation-delay: 0.1s; }
                    .card-animate:nth-child(2) { animation-delay: 0.2s; }
                    .card-animate:nth-child(3) { animation-delay: 0.3s; }
                    .card-animate:nth-child(4) { animation-delay: 0.4s; }
                    .card-animate:nth-child(5) { animation-delay: 0.5s; }
                    .card-animate:nth-child(6) { animation-delay: 0.6s; }
                </style>

                <!-- Assignments Section -->
                <div id="assignmentsSection" class="mt-8 px-4 sm:px-0 pb-12" style="display: none;">
                    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                        <div class="px-4 py-5 sm:px-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Assignment Marks</h3>
                            <p class="mt-1 max-w-2xl text-sm text-gray-500">Detailed view of all assignment marks across subjects.</p>
                        </div>
                        <div class="border-t border-gray-200">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assignment</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Marks</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody id="assignmentsTableBody" class="bg-white divide-y divide-gray-200">
                                        <tr class="animate-pulse">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Debounce function to limit how often a function is called
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }
        
        // DOM Elements
        const conversationsList = document.getElementById('conversations-list');

        // Sidebar Toggle Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const toggleBtn = document.getElementById('toggleSidebar');
            const toggleIcon = document.getElementById('toggleIcon');
            const sidebarTexts = document.querySelectorAll('.sidebar-text');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const hamburgerMenu = document.getElementById('hamburgerMenu');
            const hamburgerIcon = hamburgerMenu.querySelector('.hamburger-icon');

            // Report Glitches Modal Functionality
            const reportGlitchesBtn = document.getElementById('reportGlitchesBtn');
            const reportGlitchesModal = document.getElementById('reportGlitchesModal');
            const glitchReportForm = document.getElementById('glitchReportForm');

            if (reportGlitchesBtn) {
                reportGlitchesBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    reportGlitchesModal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                });
            }

            if (reportGlitchesModal) {
                // Close glitch report modal when clicking the close button
                const closeReportGlitchesModal = reportGlitchesModal.querySelector('.close-modal');
                if (closeReportGlitchesModal) {
                    closeReportGlitchesModal.addEventListener('click', function() {
                        reportGlitchesModal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    });
                }

                // Close glitch report modal when clicking outside
                reportGlitchesModal.addEventListener('click', function(e) {
                    if (e.target === reportGlitchesModal) {
                        reportGlitchesModal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                });
            }

            if (glitchReportForm) {
                // Handle form submission
                glitchReportForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    // Get form data
                    const formData = {
                        type: document.getElementById('glitchType').value,
                        description: document.getElementById('glitchDescription').value,
                        timestamp: new Date().toISOString(),
                        userInfo: {
                            regNo: document.getElementById('regNo').textContent,
                            name: document.getElementById('fullName').textContent
                        }
                    };

                    try {
                        // Show loading state
                        const submitBtn = glitchReportForm.querySelector('button[type="submit"]');
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = `
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Submitting...
                        `;

                        // Send the data to our backend API
                        const response = await fetch('/api/report-glitch', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        });
                        
                        const result = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(result.error || 'Failed to submit report');
                        }

                        // Show success message
                        const successAlert = document.createElement('div');
                        successAlert.className = 'fixed top-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded shadow-lg z-50';
                        successAlert.innerHTML = `
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm">Thank you for reporting this issue. We'll look into it!</p>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(successAlert);

                        // Reset form and close modal
                        glitchReportForm.reset();
                        reportGlitchesModal.style.display = 'none';
                        document.body.style.overflow = 'auto';

                        // Remove success message after 5 seconds
                        setTimeout(() => {
                            successAlert.remove();
                        }, 5000);
                    } catch (error) {
                        console.error('Error submitting glitch report:', error);
                        // Show error message
                        const errorAlert = document.createElement('div');
                        errorAlert.className = 'fixed bottom-4 right-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-lg z-50';
                        errorAlert.innerHTML = `
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm">Failed to submit the report. Please try again.</p>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(errorAlert);

                        // Remove error message after 5 seconds
                        setTimeout(() => {
                            errorAlert.remove();
                        }, 5000);
                    } finally {
                        // Reset button state
                        const submitBtn = glitchReportForm.querySelector('button[type="submit"]');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Report';
                    }
                });
            }

            // Term Wise Marks Modal Functionality
            const termWiseMarksModal = document.getElementById('termWiseMarksModal');
            const termWiseMarksBtn = document.getElementById('term_wise_marks');
            const closeTermWiseMarksModal = document.querySelector('[data-modal="termWiseMarksModal"]');

            if(termWiseMarksBtn) {
                termWiseMarksBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    termWiseMarksModal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                    
                    // Get student data and display term-wise marks
                    const studentData = JSON.parse(localStorage.getItem('studentData'));
                    if (studentData && studentData.term_wise_marks) {
                        displayTermWiseMarks(studentData.term_wise_marks);
                    } else {
                        document.getElementById('termWiseMarksContainer').innerHTML = `
                            <div class="text-center py-12">
                                <p class="text-gray-500">No term-wise marks data available</p>
                            </div>
                        `;
                    }
                });
            }

            if(closeTermWiseMarksModal) {
                closeTermWiseMarksModal.addEventListener('click', function() {
                    termWiseMarksModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                });
            }

            // Close modal when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target === termWiseMarksModal) {
                    termWiseMarksModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });

            function displayTermWiseMarks(termWiseMarks) {
                const container = document.getElementById('termWiseMarksContainer');
                container.innerHTML = '';
                
                if (!termWiseMarks || termWiseMarks.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <p class="text-gray-500">No term-wise marks data available</p>
                        </div>
                    `;
                    return;
                }
                
                // Create term list container
                const termListContainer = document.createElement('div');
                termListContainer.className = 'mb-8';
                termListContainer.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Select a Term</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4" id="term-list">
                    </div>
                `;
                container.appendChild(termListContainer);
                
                // Create term details container (initially hidden)
                const termDetailsContainer = document.createElement('div');
                termDetailsContainer.id = 'term-details';
                termDetailsContainer.className = 'mt-6 hidden';
                container.appendChild(termDetailsContainer);
                
                // Create back button (initially hidden)
                const backButton = document.createElement('button');
                backButton.id = 'back-to-terms';
                backButton.className = 'mb-4 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 flex items-center hidden';
                backButton.innerHTML = `<i class="fas fa-arrow-left mr-2"></i> Back to Terms`;
                backButton.addEventListener('click', () => {
                    document.getElementById('term-list').parentElement.classList.remove('hidden');
                    document.getElementById('term-details').classList.add('hidden');
                    backButton.classList.add('hidden');
                });
                container.insertBefore(backButton, termDetailsContainer);
                
                // Add term cards to the term list
                const termList = termListContainer.querySelector('#term-list');
                
                termWiseMarks.forEach(term => {
                    const termCard = document.createElement('div');
                    termCard.className = 'bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow cursor-pointer transform hover:-translate-y-1 transition-transform';
                    termCard.innerHTML = `
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-4 text-center">
                            <h3 class="text-lg font-semibold text-white">Term ID: ${term.term_id}</h3>
                            <p class="text-xs text-indigo-100 mt-1">${term.courses.length} course${term.courses.length !== 1 ? 's' : ''}</p>
                        </div>
                    `;
                    
                    // Add click event to show term details
                    termCard.addEventListener('click', () => {
                        showTermDetails(term);
                        document.getElementById('term-list').parentElement.classList.add('hidden');
                        document.getElementById('term-details').classList.remove('hidden');
                        backButton.classList.remove('hidden');
                    });
                    
                    termList.appendChild(termCard);
                });
                
                // Function to show term details
                function showTermDetails(term) {
                    const detailsContainer = document.getElementById('term-details');
                    detailsContainer.innerHTML = `
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Term ID: ${term.term_id}</h3>
                        </div>
                    `;
                    
                    // Add each course in the term
                    term.courses.forEach(course => {
                    const courseCard = document.createElement('div');
                        courseCard.className = 'bg-white rounded-lg shadow-md overflow-hidden mb-6';
                    
                    // Create course header
                    let courseHeader = `
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 px-6 py-4">
                            <h3 class="text-lg font-semibold text-white">${course.course_name}</h3>
                        </div>
                    `;
                    
                    // Create components table
                    let componentsTable = `
                        <div class="p-6">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Component</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Marks</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Weightage</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                    `;
                    
                    // Add each component row
                    course.components.forEach(component => {
                        // Parse marks to calculate percentage
                        let marksText = component.marks;
                        let percentage = '';
                        
                        // Try to extract obtained/total from the marks string (e.g., "5/5")
                        const marksMatch = /(\d+)\/(\d+)/.exec(marksText);
                        if (marksMatch && marksMatch.length >= 3) {
                            const obtained = parseInt(marksMatch[1]);
                            const total = parseInt(marksMatch[2]);
                            
                            if (!isNaN(obtained) && !isNaN(total) && total > 0) {
                                const percentValue = (obtained / total) * 100;
                                
                                // Determine color based on percentage
                                let percentColor = 'text-green-600';
                                if (percentValue < 60) {
                                    percentColor = 'text-red-600';
                                } else if (percentValue < 75) {
                                    percentColor = 'text-yellow-600';
                                }
                                
                                percentage = `<span class="${percentColor}">(${percentValue.toFixed(0)}%)</span>`;
                            }
                        }
                        
                        componentsTable += `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${component.type}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${component.marks} ${percentage}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${component.weightage}</td>
                            </tr>
                        `;
                    });
                    
                    componentsTable += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    courseCard.innerHTML = courseHeader + componentsTable;
                        detailsContainer.appendChild(courseCard);
                });
                }
            }

            function isMobile() {
                return window.innerWidth <= 768;
            }

            function toggleSidebar() {
                if (isMobile()) {
                    sidebar.classList.toggle('collapsed');
                    sidebarOverlay.classList.toggle('active');
                    document.body.style.overflow = sidebar.classList.contains('collapsed') ? 'hidden' : 'auto';
                    
                    // Toggle hamburger icon animation
                    hamburgerIcon.classList.toggle('open');
                    
                } else {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('collapsed');
                    
                    // Toggle text visibility only in desktop mode
                    sidebarTexts.forEach(text => {
                        text.classList.toggle('hidden');
                    });
                    
                    // Change icon direction for desktop
                    if (sidebar.classList.contains('collapsed')) {
                        toggleIcon.classList.remove('fa-angle-left');
                        toggleIcon.classList.add('fa-angle-right');
                    } else {
                        toggleIcon.classList.remove('fa-angle-right');
                        toggleIcon.classList.add('fa-angle-left');
                    }
                }
            }

            toggleBtn.addEventListener('click', toggleSidebar);
            hamburgerMenu.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);

            // Close sidebar when a menu item is clicked on mobile
            const sidebarLinks = sidebar.querySelectorAll('a');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (isMobile() && sidebar.classList.contains('collapsed')) {
                        toggleSidebar();
                    }
                });
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                if (isMobile()) {
                    // Reset sidebar state on mobile
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('collapsed');
                    sidebarOverlay.classList.remove('active');
                    document.body.style.overflow = 'auto';
                    hamburgerIcon.classList.remove('open');
                    
                    // Make sure sidebar text is visible on mobile
                    sidebarTexts.forEach(text => {
                        text.classList.remove('hidden');
                    });
                    
                } else {
                    // Reset for desktop
                    sidebarOverlay.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            });

            // Check if user is logged in
            const studentData = localStorage.getItem('studentData');
            if (!studentData) {
                window.location.href = 'login.html';
                return;
            }
            
            // Parse and display student data
            displayStudentData(JSON.parse(studentData));

            // Profile dropdown toggle
            const profileDropdownToggle = document.getElementById('profileDropdownToggle');
            const logoutDropdown = document.getElementById('logoutDropdown');

            if (profileDropdownToggle && logoutDropdown) {
                profileDropdownToggle.addEventListener('click', function(event) {
                    event.stopPropagation(); // Prevent click from propagating to window
                    logoutDropdown.classList.toggle('hidden');
                });

                // Close dropdown if clicked outside
                window.addEventListener('click', function(event) {
                    if (!profileDropdownToggle.contains(event.target) && !logoutDropdown.contains(event.target)) {
                        logoutDropdown.classList.add('hidden');
                    }
                });
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('studentData');
            window.location.href = '/';
        });

        function displayStudentData(data) {
            // Display first letter of student name
            const firstLetterSpan = document.getElementById('firstLetter');
            if (firstLetterSpan && data.studentName) {
                firstLetterSpan.textContent = data.studentName.charAt(0).toUpperCase();
            }

            // TGPA Graph and Analysis
            let chartInstances = {
                tgpa: null,
                ca: null,
                midterm: null,
                endtermTheory: null,
                endtermPractical: null
            };

            // Render TGPA graph and analysis
            renderAnalysisCharts(data.termData, data.term_wise_marks);

            // Toggle graph visibility
            const toggleGraphBtn = document.getElementById('toggleGraphBtn');
            const tgpaGraphContainer = document.getElementById('tgpaGraphContainer');

            toggleGraphBtn.addEventListener('click', () => {
                if (tgpaGraphContainer.style.display === 'none') {
                    tgpaGraphContainer.style.display = 'block';
                    toggleGraphBtn.textContent = 'Hide Analysis';
                    
                    // Force chart resize to render properly
                    Object.values(chartInstances).forEach(chart => {
                        if (chart) chart.resize();
                    });
                } else {
                    tgpaGraphContainer.style.display = 'none';
                    toggleGraphBtn.textContent = 'Graphical Analysis';
                }
            });

            // Setup tab switching
            document.querySelectorAll('#chartTabs button').forEach(button => {
                button.addEventListener('click', () => {
                    // Hide all tab contents
                    document.querySelectorAll('#chartTabContent > div').forEach(div => {
                        div.classList.add('hidden');
                        div.classList.remove('block');
                    });
                    
                    // Show selected tab content
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(tabId).classList.remove('hidden');
                    document.getElementById(tabId).classList.add('block');
                    
                    // Update active tab styling
                    document.querySelectorAll('#chartTabs button').forEach(btn => {
                        btn.classList.remove('border-indigo-600');
                        btn.classList.add('border-transparent');
                        btn.setAttribute('aria-selected', 'false');
                    });
                    button.classList.remove('border-transparent');
                    button.classList.add('border-indigo-600');
                    button.setAttribute('aria-selected', 'true');
                    
                    // Resize the chart to fit container
                    const chartId = tabId.replace('-chart', '');
                    if (chartInstances[chartId]) {
                        chartInstances[chartId].resize();
                    }
                });
            });

                        function renderAnalysisCharts(termData, termWiseMarks) {
                // Filter out terms with fewer than 4 subjects
                const filteredTerms = [];
                const filteredTgpas = [];
                const filteredLabels = [];
                
                // Process and filter term data
                termData.forEach((term, index) => {
                    const termId = term.termId;
                    const tgpa = parseFloat(term.tgpa);
                    const termInfo = termWiseMarks.find(t => t.term_id === termId);
                    
                    // Only include terms with 4 or more subjects
                    if (termInfo && termInfo.courses && termInfo.courses.length >= 4) {
                        filteredTerms.push(term);
                        filteredLabels.push(`Term ${termId}`);
                        
                        // If TGPA is 0 or NaN, set it to null
                        filteredTgpas.push((tgpa === 0 || isNaN(tgpa)) ? null : tgpa);
                    }
                });
                
                // TGPA Chart
                const tgpaCtx = document.getElementById('tgpaChart').getContext('2d');
                
                chartInstances.tgpa = new Chart(tgpaCtx, {
                    type: 'line',
                    data: {
                        labels: filteredLabels,
                        datasets: [{
                            label: 'TGPA per Term',
                            data: filteredTgpas,
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.2)',
                            tension: 0.1,
                            fill: true,
                            pointBackgroundColor: '#6366f1',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            spanGaps: false
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Term-wise TGPA Progress'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        if (value === null) {
                                            // Get term ID from filtered terms
                                            const termId = filteredTerms[context.dataIndex].termId;
                                            return `Term ${termId}: No TGPA data available`;
                                        }
                                        return `TGPA: ${value}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10, // Assuming TGPA is out of 10
                                title: {
                                    display: true,
                                    text: 'TGPA'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Term'
                                }
                            }
                        }
                    }
                });
                
                // Extract assessment data from term_wise_marks if available
                if (termWiseMarks && termWiseMarks.length > 0) {
                    // Filter termWiseMarks to only include terms with 4 or more subjects
                    const filteredTermWiseMarks = termWiseMarks.filter(term => 
                        term.courses && term.courses.length >= 4
                    );
                    
                    // Prepare data structures for other charts using filtered terms
                    const caData = prepareAssessmentData(filteredTermWiseMarks, ['Continuous Assessment', 'CA', 'Assignment', 'Continuous', 'Quiz']);
                    const midtermData = prepareAssessmentData(filteredTermWiseMarks, ['Midterm', 'Mid Term', 'Mid-Term', 'Mid Sem', 'Mid-Sem']);
                    const endtermTheoryData = prepareAssessmentData(filteredTermWiseMarks, ['End Term Theory', 'End-Term Theory', 'Final Theory', 'End Term', 'End-Term', 'Final', 'Theory', 'Exam']);
                    const endtermPracticalData = prepareAssessmentData(filteredTermWiseMarks, ['End Term Practical', 'End-Term Practical', 'Final Practical', 'Lab', 'Practical', 'Practicals', 'Laboratory']);
                    
                    // Render other charts
                    renderAssessmentChart('caChart', 'Continuous Assessment Marks', caData);
                    renderAssessmentChart('midtermChart', 'Midterm Marks', midtermData);
                    renderAssessmentChart('endtermTheoryChart', 'End Term Theory Marks', endtermTheoryData);
                    renderAssessmentChart('endtermPracticalChart', 'End Term Practical Marks', endtermPracticalData);
                    
                    // Populate term details accordion
                    populateTermDetails(termWiseMarks);
                }
            }
            
            function prepareAssessmentData(termWiseMarks, componentTypes) {
                const termData = {};
                
                // Process each term
                termWiseMarks.forEach(term => {
                    const termId = term.term_id;
                    if (!termData[termId]) {
                        termData[termId] = {
                            totalObtained: 0,
                            totalMax: 0,
                            courses: []
                        };
                    }
                    
                    // Process each course in the term
                    term.courses.forEach(course => {
                        const courseData = {
                            name: course.course_name,
                            components: []
                        };
                        
                        // Find matching components
                        course.components.forEach(component => {
                            const componentTypeLower = component.type.toLowerCase();
                            // Check if any of the componentTypes match this component
                            const matchesType = componentTypes.some(type => {
                                const typeLower = type.toLowerCase();
                                return componentTypeLower.includes(typeLower) || 
                                       // Handle special case for end term theory vs practical
                                       (componentTypeLower.includes('end') && componentTypeLower.includes('term') && 
                                        ((typeLower === 'theory' && !componentTypeLower.includes('practical')) ||
                                         (typeLower === 'practical' && componentTypeLower.includes('practical'))));
                            });
                            
                            if (matchesType) {
                                // Extract marks (e.g., "8/10")
                                const marksMatch = /(\d+)\/(\d+)/.exec(component.marks);
                                if (marksMatch && marksMatch.length >= 3) {
                                    const obtained = parseInt(marksMatch[1]);
                                    const total = parseInt(marksMatch[2]);
                                    
                                    if (!isNaN(obtained) && !isNaN(total)) {
                                        courseData.components.push({
                                            type: component.type,
                                            obtained: obtained,
                                            total: total,
                                            percentage: (obtained / total) * 100
                                        });
                                        
                                        termData[termId].totalObtained += obtained;
                                        termData[termId].totalMax += total;
                                    }
                                }
                            }
                        });
                        
                        if (courseData.components.length > 0) {
                            termData[termId].courses.push(courseData);
                        }
                    });
                });
                
                // Calculate percentages for each term
                const result = [];
                Object.keys(termData).forEach(termId => {
                    const term = termData[termId];
                    const percentage = term.totalMax > 0 ? 
                        (term.totalObtained / term.totalMax) * 100 : 0;
                    
                    result.push({
                        termId: termId,
                        percentage: percentage.toFixed(1),
                        totalObtained: term.totalObtained,
                        totalMax: term.totalMax,
                        courses: term.courses
                    });
                });
                
                // Sort by term ID
                result.sort((a, b) => parseInt(a.termId) - parseInt(b.termId));
                
                // For terms with no data, percentage is 0, or fewer than 6 subjects, set percentage to null
                // to create a gap in the chart line
                result.forEach(term => {
                    // Find the original term info to check subject count
                    const termInfo = termWiseMarks.find(t => t.term_id === term.termId);
                    
                    if (parseFloat(term.percentage) === 0 || term.totalMax === 0 ||
                        !termInfo || (termInfo.courses && termInfo.courses.length < 6)) {
                        term.percentage = null;
                    }
                });
                
                return result;
            }
            
            function renderAssessmentChart(canvasId, title, assessmentData) {
                if (!assessmentData || assessmentData.length === 0) {
                    // Display "No data available" message
                    const canvas = document.getElementById(canvasId);
                    const container = canvas.parentNode;
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-64">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                <i class="fa-duotone fa-thin fa-chart-simple text-gray-300 text-2xl"></i>
                            </div>
                            <p class="text-gray-500">No ${title.toLowerCase()} data available</p>
                        </div>
                    `;
                    return;
                }
                
                const ctx = document.getElementById(canvasId).getContext('2d');
                const chartType = canvasId.replace('Chart', '');
                
                const labels = assessmentData.map(term => `Term ${term.termId}`);
                const percentages = assessmentData.map(term => parseFloat(term.percentage));
                
                chartInstances[chartType] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: title,
                            data: percentages,
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.2)',
                            tension: 0.1,
                            fill: true,
                            pointBackgroundColor: '#6366f1',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            spanGaps: false
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: title
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const term = assessmentData[context.dataIndex];
                                        if (term.percentage === null) {
                                            return [`Term ${term.termId}: No data available`];
                                        }
                                        return [
                                            `Percentage: ${term.percentage}%`,
                                            `Marks: ${term.totalObtained}/${term.totalMax}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Percentage (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Term'
                                }
                            }
                        }
                    }
                });
            }
            
            function populateTermDetails(termWiseMarks) {
                const accordionContainer = document.getElementById('termDetailsAccordion');
                accordionContainer.innerHTML = '';
                
                if (!termWiseMarks || termWiseMarks.length === 0) {
                    accordionContainer.innerHTML = `
                        <div class="text-center py-6">
                            <p class="text-gray-500">No term details available</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort terms by ID
                const sortedTerms = [...termWiseMarks].sort((a, b) => 
                    parseInt(a.term_id) - parseInt(b.term_id)
                );
                
                sortedTerms.forEach((term, index) => {
                    const termId = term.term_id;
                    const isFirst = index === 0;
                    
                    const termCard = document.createElement('div');
                    termCard.className = 'bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden';
                    
                    // Create header
                    const header = document.createElement('button');
                    header.className = 'w-full flex items-center justify-between px-6 py-4 text-left';
                    
                    // Check if term has fewer than 4 subjects
                    const subjectCount = term.courses.length;
                    const isExcluded = subjectCount < 4;
                    
                    header.innerHTML = `
                        <div>
                            <h5 class="text-lg font-medium text-gray-900">Term ${termId}</h5>
                            <div class="flex items-center mt-1">
                                <span class="text-xs text-gray-500">${subjectCount} subject${subjectCount !== 1 ? 's' : ''}</span>
                                ${isExcluded ? `<span class="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded-full">Excluded from analysis (< 4 subjects)</span>` : ''}
                            </div>
                        </div>
                        <i class="fa-duotone fa-thin fa-chevron-down transform transition-transform duration-200 ${isFirst ? 'rotate-180' : ''}"></i>
                    `;
                    header.setAttribute('aria-expanded', isFirst ? 'true' : 'false');
                    header.setAttribute('aria-controls', `term-${termId}-content`);
                    
                    // Create content
                    const content = document.createElement('div');
                    content.id = `term-${termId}-content`;
                    content.className = `px-6 py-4 bg-gray-50 ${isFirst ? '' : 'hidden'}`;
                    
                    // Add courses
                    let coursesHTML = '';
                    term.courses.forEach(course => {
                        coursesHTML += `
                            <div class="mb-6 last:mb-0">
                                <h6 class="font-medium text-gray-800 mb-3">${course.course_name}</h6>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Component</th>
                                                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Marks</th>
                                                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Weightage</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                        `;
                        
                        course.components.forEach(component => {
                            // Parse marks to calculate percentage
                            let marksText = component.marks;
                            let percentage = '';
                            
                            // Try to extract obtained/total from the marks string (e.g., "5/5")
                            const marksMatch = /(\d+)\/(\d+)/.exec(marksText);
                            if (marksMatch && marksMatch.length >= 3) {
                                const obtained = parseInt(marksMatch[1]);
                                const total = parseInt(marksMatch[2]);
                                
                                if (!isNaN(obtained) && !isNaN(total) && total > 0) {
                                    const percentValue = (obtained / total) * 100;
                                    
                                    // Determine color based on percentage
                                    let percentColor = 'text-green-600';
                                    if (percentValue < 60) {
                                        percentColor = 'text-red-600';
                                    } else if (percentValue < 75) {
                                        percentColor = 'text-yellow-600';
                                    }
                                    
                                    percentage = `<span class="${percentColor} ml-2">(${percentValue.toFixed(0)}%)</span>`;
                                }
                            }
                            
                            coursesHTML += `
                                <tr>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${component.type}</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${component.marks} ${percentage}</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${component.weightage}</td>
                                </tr>
                            `;
                        });
                        
                        coursesHTML += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    });
                    
                    content.innerHTML = coursesHTML;
                    
                    // Toggle functionality
                    header.addEventListener('click', () => {
                        const isExpanded = header.getAttribute('aria-expanded') === 'true';
                        const icon = header.querySelector('i');
                        
                        if (isExpanded) {
                            content.classList.add('hidden');
                            icon.classList.remove('rotate-180');
                            header.setAttribute('aria-expanded', 'false');
                        } else {
                            content.classList.remove('hidden');
                            icon.classList.add('rotate-180');
                            header.setAttribute('aria-expanded', 'true');
                        }
                    });
                    
                    // Add to accordion
                    termCard.appendChild(header);
                    termCard.appendChild(content);
                    accordionContainer.appendChild(termCard);
                });
            }


            // Basic info
            document.getElementById('studentName').textContent = data.studentName || 'Student';
            document.getElementById('fullName').textContent = data.studentName || 'N/A';
            document.getElementById('regNo').textContent = data.regNo || 'N/A';
            // document.getElementById('email').textContent = data.email || 'N/A';
            document.getElementById('program').textContent = data.program || 'N/A';
            document.getElementById('section').textContent = data.section || 'N/A';
            document.getElementById('dateOfBirth').textContent = data.dateOfBirth || 'N/A';
            document.getElementById('aggAttendance').textContent = data.aggAttendance+"%" || 'N/A';
            document.getElementById('rollNumber').textContent = data.rollNumber || 'N/A';
            document.getElementById('pendingFee').textContent = data.pendingFee || 'N/A';
            // document.getElementById('encryptedDob').textContent = data.encryptedDob || 'N/A';
            // document.getElementById('studentUid').textContent = data.studentUid || 'N/A';
            
            // Stats
            document.getElementById('cgpa').textContent = data.cgpa || 'N/A';
            document.getElementById('totalCredits').textContent = data.totalCredits || 'N/A';
            // document.getElementById('currentTerm').textContent = data.currentTerm || 'N/A';
            
            // TGPA List
            const tgpaList = document.getElementById('tgpaList');
            tgpaList.innerHTML = '';
            
            if (data.termData && data.termData.length > 0) {
                data.termData.forEach(term => {
                    tgpaList.innerHTML += `
                        <li class="px-4 py-4 sm:px-6 hover:bg-gray-50">
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-medium text-indigo-600 truncate">Term ID: ${term.termId}</p>
                                <div class="ml-2 flex-shrink-0 flex">
                                    <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                        TGPA: ${term.tgpa}
                                    </p>
                                </div>
                            </div>
                        </li>
                    `;
                });
            } else {
                tgpaList.innerHTML = '<li class="px-4 py-4 sm:px-6">No term data available</li>';
            }
            
            // Grades Table and Cards
            const gradesTableBody = document.getElementById('gradesTableBody');
            const cardView = document.getElementById('cardView');
            const tableView = document.getElementById('tableView');
            const viewToggleBtn = document.getElementById('viewToggleBtn');
            const viewToggleText = document.getElementById('viewToggleText');
            
            gradesTableBody.innerHTML = '';
            cardView.innerHTML = '';
            
            // Toggle between table and card view
            viewToggleBtn.addEventListener('click', function() {
                if (tableView.classList.contains('hidden')) {
                    // Switch to table view
                    tableView.classList.remove('hidden');
                    cardView.classList.add('hidden');
                    viewToggleText.textContent = 'Card View';
                    viewToggleBtn.querySelector('i').classList.remove('fa-table');
                    viewToggleBtn.querySelector('i').classList.add('fa-th-large');
                } else {
                    // Switch to card view
                    tableView.classList.add('hidden');
                    cardView.classList.remove('hidden');
                    viewToggleText.textContent = 'Table View';
                    viewToggleBtn.querySelector('i').classList.remove('fa-th-large');
                    viewToggleBtn.querySelector('i').classList.add('fa-table');
                }
            });
            
            if (data.grades && data.grades.length > 0) {
                const gradeCounts = {};
                data.grades.forEach(grade => {
                    const gradeValue = grade.grade.trim();
                    if (gradeValue) {
                        gradeCounts[gradeValue] = (gradeCounts[gradeValue] || 0) + 1;
                    }
                });

                const gradeCountsDiv = document.getElementById('gradeCounts');
                let gradeCountsHtml = '';
                for (const grade in gradeCounts) {
                    gradeCountsHtml += `
                        <div class="inline-flex items-center px-2.5 py-1 bg-indigo-50 rounded-md">
                            <span class="text-sm font-medium text-indigo-700">${grade}</span>
                            <span class="ml-1.5 text-sm font-semibold text-indigo-900">${gradeCounts[grade]}</span>
                        </div>
                    `;
                }
                gradeCountsDiv.innerHTML = gradeCountsHtml;

                // Populate both table and card views
                data.grades.forEach((grade, index) => {
                    // Determine color based on grade
                    let gradeColor = 'text-green-800 bg-green-50';
                    let gradeBgColor = 'bg-gray-100 text-gray-700';
                    
                    if (grade.grade.startsWith('O')) {
                        gradeColor = 'text-purple-800 bg-purple-50';
                        gradeBgColor = 'bg-gray-100 text-gray-800';
                    } else if (grade.grade.startsWith('A+')) {
                        gradeColor = 'text-indigo-800 bg-indigo-50';
                        gradeBgColor = 'bg-gray-100 text-gray-800';
                    } else if (grade.grade.startsWith('A')) {
                        gradeColor = 'text-blue-800 bg-blue-50';
                        gradeBgColor = 'bg-gray-100 text-gray-800';
                    } else if (grade.grade.startsWith('B+')) {
                        gradeColor = 'text-teal-800 bg-teal-50';
                        gradeBgColor = 'bg-gray-100 text-gray-800';
                    } else if (grade.grade.startsWith('B')) {
                        gradeColor = 'text-green-800 bg-green-50';
                        gradeBgColor = 'bg-gray-100 text-gray-800';
                    } else if (grade.grade.startsWith('C')) {
                        gradeColor = 'text-yellow-800 bg-yellow-50';
                        gradeBgColor = 'bg-gray-100 text-gray-800';
                    } else if (grade.grade.startsWith('D')) {
                        gradeColor = 'text-orange-800 bg-orange-50';
                        gradeBgColor = 'bg-gray-100 text-gray-800';
                    } else if (grade.grade.startsWith('F')) {
                        gradeColor = 'text-red-800 bg-red-50';
                        gradeBgColor = 'bg-gray-100 text-gray-800';
                    }
                    
                    // Add table row with animation
                    gradesTableBody.innerHTML += `
                        <tr class="table-row-animate hover:bg-gray-50 transition-colors" style="opacity: 0;">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${grade.course}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-0.5 rounded text-xs font-normal credit-pill">${grade.credits}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 inline-flex text-xs leading-5 font-medium rounded ${gradeColor}">
                                    ${grade.grade}
                                </span>
                            </td>
                        </tr>
                    `;
                    
                    // Add card with animation
                    const card = document.createElement('div');
                    card.className = `course-card card-animate bg-white rounded-md p-4 opacity-0`;
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <div class="h-12 mb-1">
                                    <h3 class="font-medium text-gray-800 text-base line-clamp-2">${grade.course}</h3>
                                </div>
                                <span class="px-2 py-0.5 rounded text-xs font-normal credit-pill inline-block">
                                    ${grade.credits} Credits
                                </span>
                            </div>
                            <div class="grade-badge ${gradeBgColor}" style="border-left: 3px solid ${getGradeColor(grade.grade)}">
                                ${grade.grade}
                            </div>
                        </div>
                        <div class="absolute bottom-4 left-4 right-4 pt-3 border-t border-gray-100">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-xs text-gray-400">Grade Points</p>
                                    <p class="text-base font-medium text-gray-700">${getGradePoints(grade.grade)}</p>
                                </div>
                                <div class="flex items-center">
                                    <span class="text-xs text-gray-500">${getGradeDescription(grade.grade)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    cardView.appendChild(card);
                });
            } else {
                gradesTableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No grade data available</td>
                    </tr>
                `;
                
                cardView.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-12 text-center">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-book text-gray-300 text-3xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-700 mb-1">No grade data available</h3>
                        <p class="text-sm text-gray-500">Grades will appear here once they're released</p>
                    </div>
                `;
            }
            
            // Helper functions for grade information
            function getGradePoints(grade) {
                const gradePoints = {
                    'O': 10, 'A+': 9, 'A': 8, 'B+': 7, 'B': 6, 'C': 5, 'D': 4, 'F': 0
                };
                return gradePoints[grade] || 0;
            }
            
            function getGradeDescription(grade) {
                const descriptions = {
                    'O': 'Outstanding', 'A+': 'Excellent', 'A': 'Very Good', 
                    'B+': 'Good', 'B': 'Above Average', 'C': 'Average', 
                    'D': 'Pass', 'F': 'Fail'
                };
                return descriptions[grade] || '';
            }
            
            function getGradeColor(grade) {
                // Subtle colors based on grade points
                const colors = {
                    'O': '#8b5cf6',  // Purple - subtle
                    'A+': '#6366f1', // Indigo - subtle
                    'A': '#3b82f6',  // Blue - subtle
                    'B+': '#10b981', // Emerald - subtle
                    'B': '#84cc16',  // Lime - subtle
                    'C': '#f59e0b',  // Amber - subtle
                    'D': '#f97316',  // Orange - subtle
                    'F': '#ef4444'   // Red - subtle
                };
                return colors[grade] || '#d1d5db'; // Default gray
            }

            // Assignments Section Toggle
            const assignmentsBtn = document.getElementById('assignmentsBtn');
            const assignmentsSection = document.getElementById('assignmentsSection');
            const gradesSection = document.querySelector('.mt-8.px-4.sm\\:px-0.pb-12');
            const tgpaSection = document.querySelector('.mt-8.px-4.sm\\:px-0');

            assignmentsBtn.addEventListener('click', function(e) {
                e.preventDefault();
                // Removed lines that hide gradesSection and tgpaSection
                // assignmentsSection.style.display = 'block'; // This section is for the old assignments display, not the modal
                // gradesSection.style.display = 'none';
                // tgpaSection.style.display = 'none';
            });

            // Assignments Modal Functionality
            const assignmentsModal = document.getElementById('assignmentsModal');
            const closeModal = document.querySelector('.close-modal');

            assignmentsBtn.addEventListener('click', function(e) {
                e.preventDefault();
                assignmentsModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            });

            closeModal.addEventListener('click', function() {
                assignmentsModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });

            window.addEventListener('click', function(e) {
                if (e.target === assignmentsModal) {
                    assignmentsModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });

            // Function to display assignments data
            function displayAssignmentsData(data) {
                const assignmentsContainer = document.getElementById('assignmentsContainer');
                assignmentsContainer.innerHTML = '';

                if (data.assignments && data.assignments.length > 0) {
                    // Group assignments by course code
                    const courseGroups = {};
                    
                    data.assignments.forEach(assignment => {
                        const courseCode = assignment['Course Code'];
                        if (!courseGroups[courseCode]) {
                            courseGroups[courseCode] = [];
                        }
                        courseGroups[courseCode].push(assignment);
                    });

                    // Create cards for each course
                    Object.entries(courseGroups).forEach(([courseCode, assignments]) => {
                        const card = document.createElement('div');
                        card.className = 'subject-card p-6';
                        
                        // Calculate total marks for the course
                        let totalObtained = 0;
                        let totalMarks = 0;
                        
                        assignments.forEach(assignment => {
                            const obtained = parseFloat(assignment['Obtained Marks']) || 0;
                            const total = parseFloat(assignment['Total Marks']) || 0;
                            totalObtained += obtained;
                            totalMarks += total;
                        });
                        
                        const percentage = totalMarks > 0 ? ((totalObtained / totalMarks) * 100).toFixed(1) : 0;
                        
                        // Determine color based on percentage
                        let percentageColor = '';
                        if (percentage >= 70) {
                            percentageColor = 'bg-green-100 text-green-800';
                        } else if (percentage >= 50) {
                            percentageColor = 'bg-yellow-100 text-yellow-800';
                        } else {
                            percentageColor = 'bg-red-100 text-red-800';
                        }
                        
                        card.innerHTML = `
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-lg font-semibold text-gray-900">${courseCode}</h3>
                                <span hidden class="px-3 py-1 rounded-full text-sm font-medium ${percentageColor}">
                                    ${percentage}%
                                </span>
                            </div>
                            <div class="space-y-3">
                                ${assignments.map(assignment => {
                                    const obtained = parseFloat(assignment['Obtained Marks']) || 0;
                                    const total = parseFloat(assignment['Total Marks']) || 0;
                                    const assignmentPercentage = total > 0 ? ((obtained / total) * 100).toFixed(1) : 0;
                                    
                                    // Determine color for individual assignment
                                    let assignmentColor = '';
                                    if (assignmentPercentage >= 70) {
                                        assignmentColor = 'bg-green-100 text-green-800';
                                    } else if (assignmentPercentage >= 50) {
                                        assignmentColor = 'bg-yellow-100 text-yellow-800';
                                    } else {
                                        assignmentColor = 'bg-red-100 text-red-800';
                                    }
                                    
                                    return `
                                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                            <div>
                                                <p class="text-sm font-medium text-gray-900">${assignment['Type']} Assignment</p>
                                                <p class="text-xs text-gray-500">${assignment['Obtained Marks']}/${assignment['Total Marks']} marks</p>
                                            </div>
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${assignmentColor}">
                                                ${assignmentPercentage}%
                                            </span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                        assignmentsContainer.appendChild(card);
                    });
                } else {
                    assignmentsContainer.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <p class="text-gray-500">No assignment data available</p>
                        </div>
                    `;
                }
            }

            // Display assignments data
            displayAssignmentsData(data);

            // Trigger animations for table rows and cards
            setTimeout(() => {
                document.querySelectorAll('.table-row-animate').forEach(row => {
                    row.style.opacity = '1';
                });
                document.querySelectorAll('.card-animate').forEach(card => {
                    card.style.opacity = '1';
                });
            }, 100);
            
            // Display announcements data
            function displayAnnouncementsData(data) {
                const announcementsContainer = document.getElementById('announcementsContainer');
                
                if (data.announcements && data.announcements.length > 0) {
                    announcementsContainer.innerHTML = '';
                    
                    data.announcements.forEach(announcement => {
                        const card = document.createElement('div');
                        card.className = 'bg-white rounded-lg shadow-md p-6 mb-4';
                        
                        card.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-lg font-semibold text-gray-900">${announcement.subject}</h3>
                                <div class="text-sm text-gray-500">${announcement.date} ${announcement.time}</div>
                            </div>
                            <p class="text-gray-700 mb-4">${announcement.announcement}</p>
                            <div class="flex justify-between items-center text-sm text-gray-500">
                                <span>Posted by: ${announcement.employeeName || announcement.uploadedBy}</span>
                            </div>
                        `;
                        
                        announcementsContainer.appendChild(card);
                    });
                } else {
                    announcementsContainer.innerHTML = `
                        <div class="text-center py-12">
                            <p class="text-gray-500">No announcements available</p>
                        </div>
                    `;
                }
            }
            
            // Display messages data
            function displayMessagesData(data) {
                const messagesContainer = document.getElementById('messagesContainer');
                
                if (data.messages && data.messages.length > 0) {
                    messagesContainer.innerHTML = '';
                    
                    data.messages.forEach(message => {
                        const card = document.createElement('div');
                        card.className = 'bg-white rounded-lg shadow-md p-6 mb-4';
                        
                        card.innerHTML = `
                            <div class="mb-2">
                                <h3 class="text-lg font-semibold text-gray-900">${message.title}</h3>
                            </div>
                            <p class="text-gray-700">${message.message}</p>
                        `;
                        
                        messagesContainer.appendChild(card);
                    });
                } else {
                    messagesContainer.innerHTML = `
                        <div class="text-center py-12">
                            <p class="text-gray-500">No messages available</p>
                        </div>
                    `;
                }
            }
            
            // Display attendance data
            function displayAttendanceData(data) {
                const attendanceContainer = document.getElementById('attendanceContainer');
                
                if (data.attendance && data.attendance.length > 0) {
                    attendanceContainer.innerHTML = '';
                    
                    // Get the aggregate attendance from student info
                    const aggAttendance = data.aggAttendance || "0%";
                    const aggAttendanceValue = parseFloat(aggAttendance) || 0;
                    
                    // Calculate overall attendance stats for additional info
                    let totalAttended = 0;
                    let totalDelivered = 0;
                    let lowestAttendance = 100;
                    let lowestCourse = '';
                    
                    data.attendance.forEach(item => {
                        const attended = parseInt(item.attended) || 0;
                        const delivered = parseInt(item.delivered) || 0;
                        const percentageStr = item.attendance_percentage || "0%";
                        const percentage = parseFloat(percentageStr) || 0;
                        
                        totalAttended += attended;
                        totalDelivered += delivered;
                        
                        if (percentage < lowestAttendance) {
                            lowestAttendance = percentage;
                            lowestCourse = item.course;
                        }
                    });
                    
                    // Add overall summary section with aggregate attendance
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg shadow-md p-6 mb-6 text-white';
                    
                    // Determine status color for aggregate attendance
                    let aggStatusClass = '';
                    if (aggAttendanceValue >= 75) {
                        aggStatusClass = 'bg-green-400 bg-opacity-30';
                    } else if (aggAttendanceValue >= 65) {
                        aggStatusClass = 'bg-yellow-400 bg-opacity-30';
                    } else {
                        aggStatusClass = 'bg-red-400 bg-opacity-30';
                    }
                    
                    // Create unique ID for aggregate circle
                    const aggCircleId = `attendance-circle-agg-${Math.random().toString(36).substr(2, 9)}`;
                    
                    summaryDiv.innerHTML = `
                        <div class="flex flex-col md:flex-row justify-between items-center">
                            <div class="mb-4 md:mb-0 flex-1">
                                <h3 class="text-xl font-bold">Overall Attendance</h3>
                                <p class="text-indigo-100">Total Classes: ${totalAttended}/${totalDelivered}</p>
                                ${lowestAttendance < 75 ? 
                                    `<p class="text-xs mt-2 text-indigo-100">Lowest attendance: ${lowestAttendance}% in ${lowestCourse.split(':')[0]}</p>` : ''}
                            </div>
                            <div class="flex flex-col items-center">
                                <div id="${aggCircleId}" class="attendance-circle relative w-28 h-28 mb-2 ${aggAttendanceValue < 75 ? 'animate-pulse' : ''}">
                                    <!-- SVG Circle -->
                                    <svg width="100%" height="100%" viewBox="0 0 36 36">
                                        <circle cx="18" cy="18" r="15.9155" fill="none" stroke="#F3F4F6" stroke-width="3.5" stroke-opacity="0.3"></circle>
                                        <path class="circle"
                                            d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                            fill="none"
                                            stroke="white"
                                            stroke-width="3.5"
                                            stroke-dasharray="0, 100"
                                        />
                                    </svg>
                                    
                                    <!-- Percentage overlay with HTML instead of SVG text -->
                                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                                        <span class="text-xs font-medium text-white opacity-80">AGGREGATE</span>
                                        <span class="text-xl font-bold text-white">${aggAttendance}</span>
                                    </div>
                                </div>
                                <div class="text-sm font-medium ${aggStatusClass} px-3 py-1 rounded-full">
                                    ${aggAttendanceValue >= 75 ? 'Excellent!' : aggAttendanceValue >= 65 ? 'Satisfactory' : 'Needs Improvement'}
                                </div>
                            </div>
                        </div>
                    `;
                    attendanceContainer.appendChild(summaryDiv);
                    
                    // Animate the aggregate attendance circle
                    setTimeout(() => {
                        const aggCircle = document.querySelector(`#${aggCircleId} .circle`);
                        if (aggCircle) {
                            aggCircle.style.transition = 'stroke-dasharray 1.8s ease-out';
                            aggCircle.setAttribute('stroke-dasharray', `${aggAttendanceValue}, 100`);
                        }
                    }, 300);
                    
                    // Add individual course cards
                    data.attendance.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'bg-white rounded-lg shadow-md p-6 mb-4 hover:shadow-lg transition-shadow duration-300';
                        
                        // Parse attendance percentage from the string (e.g., "94%")
                        const percentageStr = item.attendance_percentage || "0%";
                        // Extract just the number from the percentage string (remove % sign)
                        const percentage = parseFloat(percentageStr) || 0;

                        let statusColor = '';
                        let circleColor = '';
                        let pulseClass = '';
                        
                        if (percentage >= 75) {
                            statusColor = 'bg-green-100 text-green-800';
                            circleColor = '#10B981'; // green-500
                        } else if (percentage >= 65) {
                            statusColor = 'bg-yellow-100 text-yellow-800';
                            circleColor = '#F59E0B'; // amber-500
                            pulseClass = 'animate-pulse';
                        } else {
                            statusColor = 'bg-red-100 text-red-800';
                            circleColor = '#EF4444'; // red-500
                            pulseClass = 'animate-pulse';
                        }

                        // Create unique ID for this circle
                        const circleId = `attendance-circle-${Math.random().toString(36).substr(2, 9)}`;

                        card.innerHTML = `
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-lg font-semibold text-gray-900">${item.course}</h3>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div class="flex flex-col items-center justify-center">
                                    <div id="${circleId}" class="attendance-circle relative w-24 h-24 mb-2 ${pulseClass}">
                                        <!-- SVG Circle -->
                                        <svg width="100%" height="100%" viewBox="0 0 36 36">
                                            <circle cx="18" cy="18" r="15.9155" fill="none" stroke="#F3F4F6" stroke-width="3"></circle>
                                            <path class="circle"
                                                d="M18 2.0845
                                                a 15.9155 15.9155 0 0 1 0 31.831
                                                a 15.9155 15.9155 0 0 1 0 -31.831"
                                                fill="none"
                                                stroke="${circleColor}"
                                                stroke-width="3"
                                                stroke-dasharray="0, 100"
                                            />
                                        </svg>
                                        
                                        <!-- Percentage overlay with HTML instead of SVG text -->
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <span class="text-lg font-bold" style="color: ${circleColor}">${percentageStr}</span>
                                        </div>
                                    </div>
                                    <span class="text-sm font-medium ${statusColor} px-2 py-1 rounded-full">
                                        ${percentage < 75 ? 'Warning!' : 'Good!'}
                                </span>
                            </div>
                                <div class="col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div>
                                    <p class="text-gray-500">Attended/Delivered</p>
                                    <p class="font-medium text-gray-800">${item.attended}/${item.delivered}</p>
                                </div>
                                <div>
                                    <p class="text-gray-500">Duty Leaves</p>
                                    <p class="font-medium text-gray-800">${item.duty_leaves}</p>
                                </div>
                                <div>
                                    <p class="text-gray-500">Last Attended</p>
                                    <p class="font-medium text-gray-800">${item.last_attended}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        attendanceContainer.appendChild(card);
                        
                        // Add animation effect with delay for visual appeal
                        setTimeout(() => {
                            const circle = document.querySelector(`#${circleId} .circle`);
                            if (circle) {
                                circle.style.transition = 'stroke-dasharray 1.5s ease-out';
                                circle.setAttribute('stroke-dasharray', `${percentage}, 100`);
                            }
                        }, 300);
                    });
                } else {
                    attendanceContainer.innerHTML = `
                        <div class="text-center py-12">
                            <p class="text-gray-500">No attendance data available</p>
                        </div>
                    `;
                }
            }
            
            // Display all data
            displayAnnouncementsData(data);
            displayMessagesData(data);
            displayAttendanceData(data);
        }
        // Rank Check Modal Functionality
        const rankCheckModal = document.getElementById('rankCheckModal');
        const rankCheckForm = document.getElementById('rankCheckForm');
        const rankResult = document.getElementById('rankResult');

        // Open the modal when the sidebar link is clicked
        const rankSidebarBtn = document.getElementById('rankCheckBtn');
        if(rankSidebarBtn) {
            rankSidebarBtn.addEventListener('click', function(e) {
                e.preventDefault();
                rankCheckModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            });
        }

        // Close modal when clicking the close button
        const closeRankModalBtn = document.querySelector('[data-modal="rankCheckModal"]');
        if(closeRankModalBtn) {
            closeRankModalBtn.addEventListener('click', function() {
                rankCheckModal.style.display = 'none';
                document.body.style.overflow = 'auto';
                rankResult.classList.add('hidden');
            });
        }

        // Announcements Modal Functionality
        const announcementsModal = document.getElementById('announcementsModal');
        const announcementsBtn = document.getElementById('announcementsBtn');
        const closeAnnouncementsModal = document.querySelector('[data-modal="announcementsModal"]');

        if(announcementsBtn) {
            announcementsBtn.addEventListener('click', function(e) {
                e.preventDefault();
                announcementsModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            });
        }

        if(closeAnnouncementsModal) {
            closeAnnouncementsModal.addEventListener('click', function() {
                announcementsModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
        }

        // Messages Modal Functionality
        const messagesModal = document.getElementById('messagesModal');
        const messagesBtn = document.getElementById('messagesBtn');
        const closeMessagesModal = document.querySelector('[data-modal="messagesModal"]');

        if(messagesBtn) {
            messagesBtn.addEventListener('click', function(e) {
                e.preventDefault();
                messagesModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            });
        }

        if(closeMessagesModal) {
            closeMessagesModal.addEventListener('click', function() {
                messagesModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
        }

        // Attendance Modal Functionality
        const attendanceModal = document.getElementById('attendanceModal');
        const attendanceBtn = document.getElementById('attendanceBtn');
        const closeAttendanceModal = document.querySelector('[data-modal="attendanceModal"]');

        if(attendanceBtn) {
            attendanceBtn.addEventListener('click', function(e) {
                e.preventDefault();
                attendanceModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            });
        }

        if(closeAttendanceModal) {
            closeAttendanceModal.addEventListener('click', function() {
                attendanceModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
        }

        // TGPA Calculator Modal Functionality
        const tgpaCalculatorModal = document.getElementById('tgpaCalculatorModal');
        const tgpaCalculatorBtn = document.getElementById('tgpaCalculatorBtn');
        const closeTgpaCalculatorModal = document.querySelector('[data-modal="tgpaCalculatorModal"]');

        // About Developer Modal Functionality
        const aboutDeveloperModal = document.getElementById('aboutDeveloperModal');
        const aboutDeveloperBtn = document.getElementById('aboutDeveloperBtn');
        const closeAboutDeveloperModal = document.querySelector('[data-modal="aboutDeveloperModal"]');

        if(aboutDeveloperBtn) {
            aboutDeveloperBtn.addEventListener('click', function(e) {
                e.preventDefault();
                aboutDeveloperModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            });
        }

        if(closeAboutDeveloperModal) {
            closeAboutDeveloperModal.addEventListener('click', function() {
                aboutDeveloperModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
        }

        // Close About Developer modal when clicking outside
        aboutDeveloperModal.addEventListener('click', function(e) {
            if (e.target === aboutDeveloperModal) {
                aboutDeveloperModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });

        const currentSemTab = document.getElementById('currentSemTab');
        const otherSemTab = document.getElementById('otherSemTab');
        const currentSemContainer = document.getElementById('currentSemContainer');
        const otherSemContainer = document.getElementById('otherSemContainer');

        const gradePoints = { "O": 10, "A+": 9, "A": 8, "B+": 7, "B": 6, "C": 5, "D": 4, "F": 0 };

        function switchTab(tab) {
            if (tab === 'current') {
                currentSemTab.classList.add('border-indigo-500', 'text-indigo-600');
                currentSemTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                otherSemTab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                otherSemTab.classList.remove('border-indigo-500', 'text-indigo-600');
                currentSemContainer.classList.remove('hidden');
                otherSemContainer.classList.add('hidden');
            } else {
                otherSemTab.classList.add('border-indigo-500', 'text-indigo-600');
                otherSemTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                currentSemTab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                currentSemTab.classList.remove('border-indigo-500', 'text-indigo-600');
                otherSemContainer.classList.remove('hidden');
                currentSemContainer.classList.add('hidden');
            }
        }

        currentSemTab.addEventListener('click', () => switchTab('current'));
        otherSemTab.addEventListener('click', () => switchTab('other'));

        function getGradeFromValue(value) {
            const grades = ['D', 'C', 'B', 'B+', 'A', 'A+', 'O'];
            return grades[value] || 'B';
        }

        function populateTgpaCalculator(data) {
            const subjectGradesContainer = document.getElementById('subjectGradesContainer');
            subjectGradesContainer.innerHTML = '';
            
            if (data.attendance && data.attendance.length > 0) {
                data.attendance.forEach((item, index) => {
                    const subjectDiv = document.createElement('div');
                    subjectDiv.className = 'subject-grade-item border-b pb-6';
                    const courseName = item.course;
                    subjectDiv.innerHTML = `
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <div class="mb-2 md:mb-0 flex-grow">
                                <h4 class="text-sm font-medium text-gray-900">${courseName}</h4>
                                <div class="mt-1">
                                    <input type="number" name="credit-${index}" class="subject-credit w-20 px-2 py-1 text-sm border border-gray-300 rounded-md" value="3" min="1" max="4" step="1">
                                    <span class="text-xs text-gray-500">credits</span>
                                </div>
                            </div>
                            <div class="md:ml-6 mt-3 md:mt-0 flex flex-col items-end">
                                <div class="flex items-center justify-end w-full">
                                    <span class="text-xs text-gray-500 mr-2">D</span>
                                    <input type="range" name="grade-${index}" class="subject-grade grade-slider" min="0" max="6" value="3" step="1">
                                    <span class="text-xs text-gray-500 ml-2">O</span>
                                </div>
                                <div class="mt-1 text-center">
                                    <span class="selected-grade text-sm font-medium grade-B">B</span>
                                </div>
                            </div>
                        </div>`;
                    subjectGradesContainer.appendChild(subjectDiv);
                    const slider = subjectDiv.querySelector('.subject-grade');
                    const gradeDisplay = subjectDiv.querySelector('.selected-grade');
                    slider.addEventListener('input', function() {
                        const gradeValue = parseInt(this.value);
                        const grade = getGradeFromValue(gradeValue);
                        gradeDisplay.textContent = grade;
                        gradeDisplay.className = `selected-grade text-sm font-medium grade-${grade.replace('+', '\\+')}`;
                    });
                });
            } else if (data.grades && data.grades.length > 0) {
                 data.grades.forEach((item, index) => {
                    const subjectDiv = document.createElement('div');
                    subjectDiv.className = 'subject-grade-item border-b pb-6';
                    const courseName = item.course;
                    const credits = item.credits || 3;
                    subjectDiv.innerHTML = `
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <div class="mb-2 md:mb-0 flex-grow">
                                <h4 class="text-sm font-medium text-gray-900">${courseName}</h4>
                                <div class="mt-1">
                                    <input type="number" name="credit-${index}" class="subject-credit w-20 px-2 py-1 text-sm border border-gray-300 rounded-md" value="${credits}" min="1" max="5" step="1">
                                    <span class="text-xs text-gray-500">credits</span>
                                </div>
                            </div>
                            <div class="md:ml-6 mt-3 md:mt-0 flex flex-col items-end">
                                <div class="flex items-center justify-end w-full">
                                    <span class="text-xs text-gray-500 mr-2">D</span>
                                    <input type="range" name="grade-${index}" class="subject-grade grade-slider" min="0" max="6" value="3" step="1">
                                    <span class="text-xs text-gray-500 ml-2">O</span>
                                </div>
                                <div class="mt-1 text-center">
                                    <span class="selected-grade text-sm font-medium grade-B">B</span>
                                </div>
                            </div>
                        </div>`;
                    subjectGradesContainer.appendChild(subjectDiv);
                    const slider = subjectDiv.querySelector('.subject-grade');
                    const gradeDisplay = subjectDiv.querySelector('.selected-grade');
                    slider.addEventListener('input', function() {
                        const gradeValue = parseInt(this.value);
                        const grade = getGradeFromValue(gradeValue);
                        gradeDisplay.textContent = grade;
                        gradeDisplay.className = `selected-grade text-sm font-medium grade-${grade.replace('+', '\\+')}`;
                    });
                });
            } else {
                subjectGradesContainer.innerHTML = `<div class="text-center py-6"><p class="text-gray-500">No current semester subject data available.</p></div>`;
            }
        }

        document.getElementById('calculateTgpaBtn').addEventListener('click', function() {
            const gradeSliders = document.querySelectorAll('#currentSemContainer .subject-grade');
            const creditInputs = document.querySelectorAll('#currentSemContainer .subject-credit');
            let totalPoints = 0;
            let totalCredits = 0;
            for (let i = 0; i < gradeSliders.length; i++) {
                const grade = getGradeFromValue(parseInt(gradeSliders[i].value));
                const credit = parseFloat(creditInputs[i].value);
                if (!isNaN(credit) && credit > 0) {
                    totalPoints += gradePoints[grade] * credit;
                    totalCredits += credit;
                }
            }
            const tgpaResult = document.getElementById('tgpaResult');
            const calculatedTgpa = document.getElementById('calculatedTgpa');
            const tgpaMessage = document.getElementById('tgpaMessage');
            if (totalCredits > 0) {
                const tgpa = (totalPoints / totalCredits).toFixed(2);
                calculatedTgpa.textContent = tgpa;
                tgpaMessage.textContent = getTgpaMessage(tgpa);
                tgpaResult.classList.remove('hidden');
            } else {
                alert('Please enter valid credits for at least one subject.');
            }
        });

        document.getElementById('generateFieldsBtn').addEventListener('click', function() {
            const numSubjects = parseInt(document.getElementById('numSubjects').value);
            const container = document.getElementById('otherSemGradesContainer');
            const calculateSection = document.getElementById('otherSemCalculateSection');
            container.innerHTML = '';
            if (isNaN(numSubjects) || numSubjects <= 0) {
                alert('Please enter a valid number of subjects.');
                calculateSection.classList.add('hidden');
                return;
            }
            for (let i = 0; i < numSubjects; i++) {
                const subjectDiv = document.createElement('div');
                subjectDiv.className = 'subject-grade-item border-b pb-6';
                subjectDiv.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-center justify-between">
                        <div class="mb-2 md:mb-0 flex-grow">
                             <input type="text" placeholder="Subject Name ${i + 1}" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md mb-2">
                            <div class="mt-1">
                                <input type="number" class="subject-credit w-20 px-2 py-1 text-sm border border-gray-300 rounded-md" value="3" min="1" max="5" step="0.5">
                                <span class="text-xs text-gray-500">credits</span>
                            </div>
                        </div>
                        <div class="md:ml-6 mt-3 md:mt-0 flex flex-col items-end">
                            <div class="flex items-center justify-end w-full">
                                <span class="text-xs text-gray-500 mr-2">D</span>
                                <input type="range" class="subject-grade grade-slider" min="0" max="6" value="3" step="1">
                                <span class="text-xs text-gray-500 ml-2">O</span>
                            </div>
                            <div class="mt-1 text-center">
                                <span class="selected-grade text-sm font-medium grade-B">B</span>
                            </div>
                        </div>
                    </div>`;
                container.appendChild(subjectDiv);
                const slider = subjectDiv.querySelector('.subject-grade');
                const gradeDisplay = subjectDiv.querySelector('.selected-grade');
                slider.addEventListener('input', function() {
                    const gradeValue = parseInt(this.value);
                    const grade = getGradeFromValue(gradeValue);
                    gradeDisplay.textContent = grade;
                    gradeDisplay.className = `selected-grade text-sm font-medium grade-${grade.replace('+', '\\+')}`;
                });
            }
            calculateSection.classList.remove('hidden');
        });

        document.getElementById('calculateOtherSemTgpaBtn').addEventListener('click', function() {
            const gradeSliders = document.querySelectorAll('#otherSemGradesContainer .subject-grade');
            const creditInputs = document.querySelectorAll('#otherSemGradesContainer .subject-credit');
            let totalPoints = 0;
            let totalCredits = 0;
            for (let i = 0; i < gradeSliders.length; i++) {
                const grade = getGradeFromValue(parseInt(gradeSliders[i].value));
                const credit = parseFloat(creditInputs[i].value);
                if (!isNaN(credit) && credit > 0) {
                    totalPoints += gradePoints[grade] * credit;
                    totalCredits += credit;
                }
            }
            const tgpaResult = document.getElementById('otherSemTgpaResult');
            const calculatedTgpa = document.getElementById('otherCalculatedTgpa');
            const tgpaMessage = document.getElementById('otherTgpaMessage');
            if (totalCredits > 0) {
                const tgpa = (totalPoints / totalCredits).toFixed(2);
                calculatedTgpa.textContent = tgpa;
                tgpaMessage.textContent = getTgpaMessage(tgpa);
                tgpaResult.classList.remove('hidden');
            } else {
                alert('Please enter valid credits for at least one subject.');
            }
        });

        function getTgpaMessage(tgpa) {
            if (tgpa >= 9.0) return "Outstanding Performance! 🌟";
            if (tgpa >= 8.0) return "Excellent Work! 💫";
            if (tgpa >= 7.0) return "Very Good Achievement! ⭐";
            if (tgpa >= 6.0) return "Good Progress! 👍";
            if (tgpa >= 5.0) return "Keep Working Hard! 💪";
            return "You Can Improve! 🎯";
        }

        if(tgpaCalculatorBtn) {
            tgpaCalculatorBtn.addEventListener('click', function(e) {
                e.preventDefault();
                tgpaCalculatorModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
                const studentData = JSON.parse(localStorage.getItem('studentData'));
                if (studentData) {
                    populateTgpaCalculator(studentData);
                }
                switchTab('current'); // Default to current sem tab
            });
        }

        if(closeTgpaCalculatorModal) {
            closeTgpaCalculatorModal.addEventListener('click', function() {
                tgpaCalculatorModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target === rankCheckModal) {
                rankCheckModal.style.display = 'none';
                document.body.style.overflow = 'auto';
                rankResult.classList.add('hidden');
            } else if (e.target === announcementsModal) {
                announcementsModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            } else if (e.target === messagesModal) {
                messagesModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            } else if (e.target === attendanceModal) {
                attendanceModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            } else if (e.target === tgpaCalculatorModal) {
                tgpaCalculatorModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });

        // Handle rank check form submission
        rankCheckForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const regNo = document.getElementById('rankRegNo').value;
            
            // Show loading state
            rankResult.classList.remove('hidden');
            document.getElementById('studentName').textContent = 'Loading...';
            document.getElementById('studentCourse').textContent = '-';
            document.getElementById('studentRegNo').textContent = '-';
            document.getElementById('studentState').textContent = '-';
            document.getElementById('studentCGPA').textContent = '-';
            document.getElementById('studentGender').textContent = '-';
            document.getElementById('studentBatch').textContent = '-';
            document.getElementById('studentCountry').textContent = '-';
            document.getElementById('studentRank').textContent = '-';
            document.getElementById('studentPercentile').textContent = '-';
            document.getElementById('studentTotal').textContent = '-';


            fetch('/get-student-info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ registrationNumber: regNo })
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.RegistrationNumber) {
                    document.getElementById('studentName').textContent = data.Name || '-';
                    document.getElementById('studentCourse').textContent = data.Course || '-';
                    document.getElementById('studentRegNo').textContent = data.RegistrationNumber || '-';
                    document.getElementById('studentState').textContent = data.State || '-';
                    document.getElementById('studentCGPA').textContent = data.CGPA || '-';
                    document.getElementById('studentGender').textContent = data.Gender || '-';
                    document.getElementById('studentBatch').textContent = data.BatchYear || '-';
                    document.getElementById('studentCountry').textContent = data.Country || '-';
                    document.getElementById('studentRank').textContent = data.Rank || '-';
                    document.getElementById('studentPercentile').textContent = data.Percentage ? data.Percentage + '%' : '-';
                    document.getElementById('studentTotal').textContent = data.TotalStudents || '-';
                } else {
                    // Hide rank result and show video modal
                    rankResult.classList.add('hidden');
                    showVideoModal();
                }
            })
            .catch(error => {
                // Hide rank result and show video modal
                rankResult.classList.add('hidden');
                showVideoModal();
            });
        });

        // Video Modal Functionality
        const videoModal = document.getElementById('videoModal');
        const video = document.getElementById('notFoundVideo');
        const closeVideoModalBtn = document.getElementById('closeVideoModal');

        function showVideoModal() {
            if (!videoModal || !video) return;
            videoModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            video.currentTime = 0; // Rewind to start
            video.volume = 0.2;
            const playPromise = video.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.error("Video autoplay was prevented:", error);
                    // Optionally, you can show a play button to the user here
                });
            }
        }

        function hideVideoModal() {
            if (!videoModal || !video) return;
            video.pause();
            videoModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        if (closeVideoModalBtn) {
            closeVideoModalBtn.addEventListener('click', hideVideoModal);
        }

        if (video) {
            video.onended = hideVideoModal;
        }

        if (videoModal) {
            videoModal.addEventListener('click', function(e) {
                if (e.target === videoModal) {
                    hideVideoModal();
                }
            });
        }
    
        // LinkedIn-style Messaging System
        document.addEventListener('DOMContentLoaded', function() {
            initializeMessagingSystem();
        });
        
        function initializeMessagingSystem() {
            // Create and append the messaging UI to the body
            const messagingContainer = document.createElement('div');
            messagingContainer.id = 'messaging-system';
            
            // Check if chat was minimized previously
            const wasMinimized = localStorage.getItem('chat_minimized');
            if (wasMinimized === null || wasMinimized === 'true') {
                messagingContainer.classList.add('messaging-minimized'); // Start minimized by default
                
                // Set the correct icon for minimized state
                setTimeout(() => {
                    const minimizeBtn = document.getElementById('minimize-messaging');
                    if (minimizeBtn) {
                        const icon = minimizeBtn.querySelector('i');
                        if (icon) {
                            icon.classList.remove('fa-minus');
                            icon.classList.add('fa-expand');
                        }
                    }
                }, 100);
            }
            messagingContainer.innerHTML = `
                <div class="messaging-container">
                    <!-- Messaging Header -->
                    <div class="messaging-header">
                        <div class="flex items-center justify-between w-full p-3">
                            <div class="flex items-center">
                                <i class="fas fa-comments mr-2 text-white text-lg"></i>
                                <span class="font-medium">Student Chat</span>
                                <div id="unread-count" class="ml-2 bg-white text-indigo-600 text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">0</div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button id="back-to-conversations" class="hover:text-white hidden">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <button id="minimize-messaging" class="hover:text-white">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Search Box -->
                        <div class="px-3 pb-3 search-container">
                            <div class="relative">
                                <input id="search-conversations" type="text" placeholder="Search by registration number..." class="w-full pl-9 pr-3 py-2 text-sm rounded-full focus:outline-none">
                                <i class="fas fa-search absolute left-3.5 top-2.5 text-sm"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Conversation List -->
                    <div id="conversation-list" class="conversation-list">
                        <!-- No Chats Message -->
                        <div id="no-chats-message" class="flex flex-col items-center justify-center h-full py-10">
                            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                <i class="fas fa-comments text-gray-300 text-4xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-700 mb-1">No chats to display</h3>
                            <p class="text-sm text-gray-500 text-center px-6 mb-4">Start a conversation with your classmates or professors</p>
                            <button id="find-people-btn" class="px-4 py-2 bg-indigo-100 text-indigo-600 rounded-lg font-medium text-sm hover:bg-indigo-200 transition-colors">
                                <i class="fas fa-user-plus mr-2"></i>Find people
                            </button>
                        </div>
                        
                        <!-- Conversations will be inserted here -->
                        <div id="conversations-container" class="hidden"></div>
                        
                        <!-- Search Results Container -->
                        <div id="search-results" class="hidden"></div>
                    </div>
                    
                    <!-- Active Chat Container (initially hidden) -->
                    <div id="active-chat" class="hidden flex flex-col h-full">
                        <div id="chat-header" class="bg-white border-b border-gray-200 p-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="bg-indigo-100 h-10 w-10 rounded-full flex items-center justify-center text-indigo-600 font-bold mr-3">
                                    <span id="chat-avatar"></span>
                                </div>
                                <div>
                                    <h3 id="chat-name" class="font-medium text-gray-800"></h3>
                                    <p id="chat-reg-no" class="text-xs text-gray-500"></p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="clear-chat" class="text-gray-500 hover:text-red-500 transition-colors">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50" style="height: calc(100% - 120px); margin-bottom: 150px;"></div>
                        
                        <div class="bg-white border-t border-gray-200 p-1 absolute bottom-0 w-full">
                            <div class="flex items-center space-x-2">
                                <input id="message-input" type="text" placeholder="Type a message..." class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
                                <button id="send-message" class="bg-indigo-600 text-white rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center hover:bg-indigo-700 transition-colors">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                        
                        <style>
                            @media (max-width: 480px) {
                                #message-input {
                                    padding: 0.5rem 1rem;
                                    font-size: 0.875rem;
                                }
                                
                                #send-message {
                                    width: 36px;
                                    height: 36px;
                                }
                                
                                #send-message i {
                                    font-size: 0.875rem;
                                }
                            }
                        </style>
                    </div>
                    
                    <!-- Compose Button -->
                    <div id="compose-button-container" class="compose-button-container p-3 border-t border-gray-200 bg-white" hidden>
                        <button id="compose-message" class="w-full py-2 px-4 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-full font-medium shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center">
                            <i class="fas fa-pen-alt mr-2"></i>
                            New Message
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(messagingContainer);
            
            // Add styles for the messaging system
            const styleElement = document.createElement('style');
            styleElement.textContent = `
                @keyframes slideUp {
                    from { transform: translateY(20px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
                
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
                
                @keyframes pulse {
                    0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
                    70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
                    100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
                }
                
                @keyframes gradientBg {
                    0% { background-position: 0% 50%; }
                    50% { background-position: 100% 50%; }
                    100% { background-position: 0% 50%; }
                }
                
                @keyframes expandWidth {
                    from { width: 0; opacity: 0; }
                    to { width: 90%; max-width: 380px; opacity: 1; }
                }
                
                @keyframes expandChat {
                    0% { transform: translateY(calc(100% - 60px)); }
                    50% { transform: translateY(-10px); }
                    100% { transform: translateY(0); }
                }
                
                #messaging-system {
                    position: fixed;
                    bottom: 0;
                    right: 20px;
                    z-index: 1050;
                    width: 90%;
                    max-width: 380px;
                    box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.15);
                    border-radius: 16px 16px 0 0;
                    background-color: white;
                    border: none;
                    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                    animation: expandWidth 0.6s ease-out forwards;
                    overflow: hidden;
                    transform-origin: bottom right;
                }
                
                @media (max-width: 480px) {
                    #messaging-system {
                        right: 5%;
                        left: 5%;
                        width: 90%;
                    }
                }
                
                #messaging-system:hover {
                    transform: translateY(-3px);
                    box-shadow: 0 -8px 30px rgba(0, 0, 0, 0.2);
                }
                
                .messaging-container {
                    display: flex;
                    flex-direction: column;
                    height: 520px;
                    max-height: 75vh;
                    transition: height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                }
                
                @media (max-height: 700px) {
                    .messaging-container {
                        height: 420px;
                    }
                }
                
                @media (max-height: 600px) {
                    .messaging-container {
                        height: 350px;
                    }
                }
                
                .messaging-header {
                    background: linear-gradient(135deg, #6366f1, #8b5cf6);
                    background-size: 200% 200%;
                    animation: gradientBg 5s ease infinite;
                    color: white;
                    border-radius: 16px 16px 0 0;
                    border-bottom: none;
                    padding: 4px 0;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                }
                
                .messaging-header .font-medium {
                    color: white;
                    font-weight: 600;
                    letter-spacing: 0.5px;
                }
                
                .messaging-header button {
                    color: rgba(255, 255, 255, 0.8);
                    transition: all 0.2s ease;
                }
                
                .messaging-header button:hover {
                    color: white;
                    transform: scale(1.1);
                }
                
                .conversation-list {
                    flex: 1;
                    overflow-y: auto;
                    background-color: #f9fafc;
                    padding: 8px 0;
                }
                
                .conversation-item {
                    border-bottom: 1px solid #f0f0f0;
                    transition: all 0.2s ease;
                    margin: 0 8px 4px 8px;
                    border-radius: 12px;
                    cursor: pointer;
                }
                
                .conversation-item:hover {
                    transform: translateX(5px);
                    background-color: #f0f4ff !important;
                }
                
                .conversation-item:last-child {
                    border-bottom: none;
                    margin-bottom: 0;
                }
                
                .conversation-item.unread {
                    background-color: #eef2ff;
                    border-left: 3px solid #6366f1;
                }
                
                .conversation-item .h-10.w-10 {
                    height: 42px;
                    width: 42px;
                    min-width: 42px; /* Prevent shrinking on small screens */
                    border-radius: 12px;
                    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
                    transition: all 0.3s ease;
                }
                
                @media (max-width: 480px) {
                    .conversation-item .h-10.w-10 {
                        height: 36px;
                        width: 36px;
                        min-width: 36px;
                    }
                }
                
                .conversation-item:hover .h-10.w-10 {
                    transform: scale(1.05) rotate(-3deg);
                }
                
                .conversation-item .h-2.w-2 {
                    height: 10px;
                    width: 10px;
                    animation: pulse 2s infinite;
                }
                
                .messaging-minimized {
                    height: 60px !important;
                    overflow: hidden;
                    transform: translateY(calc(100% - 60px));
                    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                    pointer-events: auto !important;
                }
                
                .messaging-minimized:hover {
                    transform: translateY(calc(100% - 65px));
                }
                
                /* Hide input area and other elements when minimized */
                .messaging-minimized #active-chat,
                .messaging-minimized #message-input,
                .messaging-minimized #send-message,
                .messaging-minimized #chat-messages,
                .messaging-minimized #search-results,
                .messaging-minimized #conversations-container,
                .messaging-minimized #compose-button-container,
                .messaging-minimized .messaging-header .search-container,
                .messaging-minimized #search-conversations,
                .messaging-minimized #no-chats-message {
                    display: none !important;
                }
                
                /* Ensure the header looks clean when minimized */
                .messaging-minimized .messaging-header {
                    height: 60px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                @media (max-width: 480px) {
                    .messaging-minimized {
                        height: 50px !important;
                        transform: translateY(calc(100% - 50px));
                        pointer-events: auto !important;
                    }
                    
                    .messaging-minimized:hover {
                        transform: translateY(calc(100% - 55px));
                    }
                    
                    .messaging-minimized * {
                        pointer-events: auto !important;
                    }
                    
                    /* Ensure only the header is visible when minimized */
                    .messaging-minimized .messaging-container {
                        height: 50px !important;
                        overflow: hidden;
                    }
                }
                
                /* Search box styling */
                .messaging-header input {
                    background-color: rgba(255, 255, 255, 0.2);
                    border: none;
                    color: white;
                    backdrop-filter: blur(5px);
                    border-radius: 20px;
                    padding-left: 30px;
                    transition: all 0.3s ease;
                    width: 100%;
                }
                
                @media (max-width: 480px) {
                    .messaging-header {
                        padding: 2px 0;
                    }
                    
                    .messaging-header .font-medium {
                        font-size: 0.9rem;
                    }
                    
                    .messaging-header input {
                        height: 32px;
                        font-size: 0.9rem;
                    }
                }
                
                .messaging-header input::placeholder {
                    color: rgba(255, 255, 255, 0.7);
                }
                
                .messaging-header input:focus {
                    background-color: rgba(255, 255, 255, 0.3);
                    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
                }
                
                .messaging-header .fa-search {
                    color: rgba(255, 255, 255, 0.7);
                }
                
                /* Custom scrollbar */
                .conversation-list::-webkit-scrollbar, #chat-messages::-webkit-scrollbar {
                    width: 5px;
                }
                
                .conversation-list::-webkit-scrollbar-track, #chat-messages::-webkit-scrollbar-track {
                    background: transparent;
                }
                
                .conversation-list::-webkit-scrollbar-thumb, #chat-messages::-webkit-scrollbar-thumb {
                    background: rgba(99, 102, 241, 0.3);
                    border-radius: 20px;
                }
                
                .conversation-list::-webkit-scrollbar-thumb:hover, #chat-messages::-webkit-scrollbar-thumb:hover {
                    background: rgba(99, 102, 241, 0.5);
                }
                
                /* Chat message bubbles */
                .message-bubble {
                    max-width: 80%;
                    padding: 10px 14px;
                    margin-bottom: 5px;
                    border-radius: 18px;
                    position: relative;
                    animation: slideUp 0.3s ease;
                    word-wrap: break-word;
                    overflow-wrap: break-word;
                }
                
                @media (max-width: 480px) {
                    .message-bubble {
                        max-width: 85%;
                        padding: 8px 12px;
                        font-size: 0.9rem;
                    }
                }
                
                .message-sent {
                    background-color: #6366f1;
                    color: white;
                    margin-left: auto;
                    border-bottom-right-radius: 4px;
                }
                
                .message-received {
                    background-color: #e5e7eb;
                    color: #1f2937;
                    margin-right: auto;
                    border-bottom-left-radius: 4px;
                }
                
                .message-time {
                    font-size: 0.7rem;
                    opacity: 0.7;
                    margin-top: 2px;
                    text-align: right;
                }
                
                .message-error {
                    opacity: 0.7;
                    border: 1px solid #f87171;
                }
                
                .message-error .message-time {
                    color: #ef4444;
                }
                
                /* Search results styling */
                .search-result-item {
                    padding: 10px;
                    border-bottom: 1px solid #f0f0f0;
                    cursor: pointer;
                    transition: all 0.2s ease;
                }
                
                .search-result-item:hover {
                    background-color: #f0f4ff;
                }
            `;
            document.head.appendChild(styleElement);
            
            // Initialize chat functionality
            initializeChatFunctions();
        }

        // Chat functionality
        function initializeChatFunctions() {
            // Get DOM elements
                const messagingSystem = document.getElementById('messaging-system');
            const minimizeBtn = document.getElementById('minimize-messaging');
            const composeBtn = document.getElementById('compose-message');
            const searchInput = document.getElementById('search-conversations');
            const backBtn = document.getElementById('back-to-conversations');
            const sendBtn = document.getElementById('send-message');
            const messageInput = document.getElementById('message-input');
            const clearChatBtn = document.getElementById('clear-chat');
            const findPeopleBtn = document.getElementById('find-people-btn');
            
            // State variables
            let currentUser = null;
            let activeChat = null;
            let conversations = [];
            let pollingInterval = null;
            
            // Get current user from localStorage (set during login)
            function getCurrentUser() {
                const userData = localStorage.getItem('studentData');
                if (userData) {
                    try {
                        const parsedData = JSON.parse(userData);
                        currentUser = {
                            regNo: parsedData.regNo,
                            studentName: parsedData.studentName
                        };
                        return currentUser;
                    } catch (e) {
                        console.error('Error parsing user data:', e);
                    }
                }
                return null;
            }
            
            // Initialize with current user
            getCurrentUser();
            
            // Add click handler to the entire messaging system when minimized
            messagingSystem.addEventListener('click', function(e) {
                // Only handle clicks on the container itself when minimized
                if (messagingSystem.classList.contains('messaging-minimized')) {
                    // Don't handle clicks on buttons or input fields
                    const isInteractive = e.target.tagName === 'BUTTON' || 
                                         e.target.closest('button') || 
                                         e.target.tagName === 'INPUT' ||
                                         e.target.tagName === 'I';
                    
                    if (!isInteractive) {
                        minimizeBtn.click();
                    }
                }
            });
            
            // Minimize/expand chat window
            minimizeBtn.addEventListener('click', function() {
                // Force a small delay to ensure proper state change
                setTimeout(() => {
                    messagingSystem.classList.toggle('messaging-minimized');
                    
                    // Change icon based on state
                    const icon = this.querySelector('i');
                    if (messagingSystem.classList.contains('messaging-minimized')) {
                        icon.classList.remove('fa-minus');
                        icon.classList.add('fa-expand');
                        
                        // Add slide-in animation
                        messagingSystem.style.animation = 'none';
                        messagingSystem.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                        
                        // Store minimized state in localStorage
                        localStorage.setItem('chat_minimized', 'true');
                    } else {
                        icon.classList.remove('fa-expand');
                        icon.classList.add('fa-minus');
                        
                        // Reset any inline styles that might interfere with maximizing
                        messagingSystem.style.animation = '';
                        messagingSystem.style.transform = '';
                        
                        // Add expand animation
                        setTimeout(() => {
                            messagingSystem.style.animation = 'expandChat 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';
                        }, 10);
                        
                        // Remove minimized state from localStorage
                        localStorage.removeItem('chat_minimized');
                        
                        // Load conversations when expanding
                        loadConversations();
                    }
                }, 50);
            });
            
            // Also add click event to messaging header to ensure it can be expanded on mobile
            const messagingHeader = messagingSystem.querySelector('.messaging-header');
            if (messagingHeader) {
                messagingHeader.addEventListener('click', function(e) {
                    // Only trigger if the clicked element is not a button or icon within the header
                    const isButton = e.target.tagName === 'BUTTON' || 
                                    e.target.closest('button') || 
                                    e.target.tagName === 'I' ||
                                    e.target.id === 'search-conversations';
                    
                    if (!isButton) {
                        if (messagingSystem.classList.contains('messaging-minimized')) {
                            minimizeBtn.click();
                        }
                    }
                });
            }
            
            // Back to conversations button
            backBtn.addEventListener('click', () => {
                showConversationList();
            });

            // Compose new message button
            composeBtn.addEventListener('click', function() {
                searchInput.value = '';
                searchInput.placeholder = 'Search by registration number...';
                document.getElementById('no-chats-message').classList.add('hidden');
                document.getElementById('conversations-container').classList.add('hidden');
                document.getElementById('search-results').classList.remove('hidden');
                document.getElementById('active-chat').classList.add('hidden');
                document.getElementById('compose-button-container').classList.add('hidden');
                backBtn.classList.remove('hidden');
                
                // Focus on search input
                searchInput.focus();
            });
            
            // Find people button
            findPeopleBtn.addEventListener('click', function() {
                composeBtn.click();
            });
            
            // Search for users
            searchInput.addEventListener('input', debounce(function() {
                const query = searchInput.value.trim();
                
                if (query.length >= 3) {
                    // Ensure chat is expanded when searching
                    if (messagingSystem.classList.contains('messaging-minimized')) {
                        messagingSystem.classList.remove('messaging-minimized');
                        const icon = minimizeBtn.querySelector('i');
                        icon.classList.remove('fa-expand');
                        icon.classList.add('fa-minus');
                    }
                    searchUsers(query);
                } else if (query.length === 0) {
                    // If in conversation list view, show conversations
                    if (document.getElementById('conversations-container').classList.contains('hidden') &&
                        document.getElementById('active-chat').classList.contains('hidden')) {
                        showConversationList();
                    }
                }
            }, 300));
            
            // Send message button
            sendBtn.addEventListener('click', function() {
                sendMessage();
            });
            
            // Send message on Enter key
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Clear chat button
            clearChatBtn.addEventListener('click', function() {
                if (activeChat) {
                    if (confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
                        deleteConversation(activeChat.regNo);
                    }
                }
            });
            
            // Load conversations
            function loadConversations() {
                if (!currentUser) {
                    currentUser = getCurrentUser();
                    if (!currentUser) return;
                }
                
                // Add loading indicator if container is empty
                const container = document.getElementById('conversations-container');
                if (container.innerHTML === '') {
                    container.innerHTML = `
                        <div class="flex justify-center p-4">
                            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-500"></div>
                        </div>
                    `;
                    container.classList.remove('hidden');
                    document.getElementById('no-chats-message').classList.add('hidden');
                }
                
                fetch(`/api/get-conversations?regNo=${currentUser.regNo}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.conversations) {
                            // Check if conversations have changed
                            const hasChanged = !conversations || 
                                conversations.length !== data.conversations.length || 
                                JSON.stringify(conversations) !== JSON.stringify(data.conversations);
                            
                            conversations = data.conversations;
                            
                            // Only update UI if conversations have changed
                            if (hasChanged) {
                                displayConversations(conversations);
                            }
                            
                            // Update unread count
                            updateUnreadCount();
                            
                            // Start polling for new messages if not already polling
                            if (!pollingInterval) {
                                startPolling();
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading conversations:', error);
                        
                        // Show error only if container has loading indicator
                        if (container.querySelector('.animate-spin')) {
                            container.innerHTML = `
                                <div class="p-4 text-center text-red-500">
                                    <i class="fas fa-exclamation-circle mb-2 text-xl"></i>
                                    <p>Failed to load conversations.</p>
                                    <button class="mt-2 px-4 py-2 bg-indigo-100 text-indigo-600 rounded-lg font-medium text-sm hover:bg-indigo-200 transition-colors">
                                        Try again
                                    </button>
                                </div>
                            `;
                            
                            // Add retry button functionality
                            const retryBtn = container.querySelector('button');
                            if (retryBtn) {
                                retryBtn.addEventListener('click', loadConversations);
                            }
                        }
                    });
            }
            
            // Display conversations
            function displayConversations(conversations) {
                const container = document.getElementById('conversations-container');
                
                if (conversations.length === 0) {
                    document.getElementById('no-chats-message').classList.remove('hidden');
                    container.classList.add('hidden');
                    return;
                }
                
                document.getElementById('no-chats-message').classList.add('hidden');
                container.classList.remove('hidden');
                container.innerHTML = '';
                
                conversations.forEach(conv => {
                    // Get student data for the other user
                    fetch(`/api/get-student-info?regNo=${conv.other_user}`)
                        .then(response => response.json())
                        .then(userData => {
                            const studentName = userData.studentName || `User ${conv.other_user}`;
                            const initials = getInitials(studentName);
                            const latestMessage = conv.latest_message;
                            const timestamp = formatTimestamp(latestMessage.timestamp);
                            const isUnread = conv.unread_count > 0;
                            
                            const conversationItem = document.createElement('div');
                            conversationItem.className = `conversation-item p-3 ${isUnread ? 'unread' : ''}`;
                            conversationItem.dataset.regNo = conv.other_user;
                            conversationItem.innerHTML = `
                                <div class="flex items-center">
                                    <div class="bg-indigo-100 h-10 w-10 rounded-full flex items-center justify-center text-indigo-600 font-bold mr-3">
                                        ${initials}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center justify-between mb-1">
                                            <h4 class="font-medium text-gray-800 truncate">${studentName}</h4>
                                            <span class="text-xs text-gray-500 ml-2 flex-shrink-0">${timestamp}</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <p class="text-sm text-gray-600 truncate flex-1">
                                                ${latestMessage.sender === currentUser.regNo ? '<span class="text-indigo-600 font-medium">You:</span> ' : ''}${latestMessage.text}
                                            </p>
                                            ${isUnread ? `<div class="bg-indigo-600 h-2 w-2 rounded-full flex-shrink-0 ml-2"></div>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            // Add click event to open chat
                            conversationItem.addEventListener('click', function() {
                                openChat(conv.other_user, studentName);
                            });
                            
                            container.appendChild(conversationItem);
                        })
                        .catch(error => {
                            console.error('Error fetching user data:', error);
                            
                            // Create a conversation item with placeholder data
                            const studentName = `User ${conv.other_user}`;
                            const initials = getInitials(studentName);
                            const latestMessage = conv.latest_message;
                            const timestamp = formatTimestamp(latestMessage.timestamp);
                            const isUnread = conv.unread_count > 0;
                            
                            const conversationItem = document.createElement('div');
                            conversationItem.className = `conversation-item p-3 ${isUnread ? 'unread' : ''}`;
                            conversationItem.dataset.regNo = conv.other_user;
                            conversationItem.innerHTML = `
                                <div class="flex items-center">
                                    <div class="bg-indigo-100 h-10 w-10 rounded-full flex items-center justify-center text-indigo-600 font-bold mr-3">
                                        ${initials}
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between">
                                            <h4 class="font-medium text-gray-800">${studentName}</h4>
                                            <span class="text-xs text-gray-500">${timestamp}</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <p class="text-sm text-gray-600 truncate max-w-[180px]">
                                                ${latestMessage.sender === currentUser.regNo ? 'You: ' : ''}${latestMessage.text}
                                            </p>
                                            ${isUnread ? `<div class="bg-indigo-600 h-2 w-2 rounded-full"></div>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            // Add click event to open chat
                            conversationItem.addEventListener('click', function() {
                                openChat(conv.other_user, studentName);
                            });
                            
                            container.appendChild(conversationItem);
                        });
                });
            }
            
            // Search for users
            function searchUsers(query) {
                // Check if query is a complete registration number (typically 8 digits)
                const isFullRegNo = /^\d{8}$/.test(query);
                
                fetch(`/api/search-users?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.results) {
                            // If it's a full registration number, show student details
                            if (isFullRegNo) {
                                showStudentDetails(query);
                            }
                            displaySearchResults(data.results);
                        } else {
                            // If it's a full registration number but no results, still try to show details
                            if (isFullRegNo) {
                                showStudentDetails(query);
                            }
                            
                            // Show error message in search results
                            const container = document.getElementById('search-results');
                            container.innerHTML = `
                                <div class="p-4 text-center text-gray-500">
                                    No users found. Try a different search term.
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('Error searching users:', error);
                        
                        // Show error message in search results
                        const container = document.getElementById('search-results');
                        container.innerHTML = `
                            <div class="p-4 text-center text-red-500">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                Error searching users. Please try again.
                            </div>
                        `;
                    });
            }
            
            // Show student details
            function showStudentDetails(regNo) {
                // Minimize chat if it's open to prevent overlap issues on mobile
                const messagingSystem = document.getElementById('messaging-system');
                if (messagingSystem && !messagingSystem.classList.contains('messaging-minimized')) {
                    const minimizeBtn = document.getElementById('minimize-messaging');
                    if (minimizeBtn) {
                        minimizeBtn.click();
                    }
                }
                
                fetch(`/api/get-student-info?regNo=${regNo}`)
                    .then(response => response.json())
                    .then(studentData => {
                        // Create a modal to display student details
                        const modalContainer = document.createElement('div');
                        modalContainer.id = 'student-details-modal';
                        modalContainer.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[1100]';
                        
                        // Format the student data
                        let detailsHTML = `
                            <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 max-h-[80vh] overflow-y-auto">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-bold text-gray-900">Student Details</h2>
                                    <button id="close-details-modal" class="text-gray-500 hover:text-gray-700">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="border-t border-gray-200 pt-4">
                                    <div class="flex flex-col items-center mb-4">
                                        <div class="bg-indigo-100 h-20 w-20 rounded-full flex items-center justify-center text-indigo-600 font-bold text-2xl mb-2">
                                            ${getInitials(studentData.studentName || 'Unknown')}
                                        </div>
                                        <h3 class="text-lg font-medium text-gray-900">${studentData.studentName || 'Unknown'}</h3>
                                        <p class="text-sm text-gray-500">${regNo}</p>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="col-span-2">
                                            <p class="text-sm font-medium text-gray-500">Program</p>
                                            <p class="text-sm text-gray-900">${studentData.program || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-500">Section</p>
                                            <p class="text-sm text-gray-900">${studentData.section || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-500">CGPA</p>
                                            <p class="text-sm text-gray-900">${studentData.cgpa || 'N/A'}</p>
                                        </div>
                `;
                
                // Add contact info if available
                if (studentData.contactInfo) {
                    detailsHTML += `
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Contact Number</p>
                                    <p class="text-sm text-gray-900">${studentData.contactInfo.contactNumber || 'N/A'}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Verified</p>
                                    <p class="text-sm text-gray-900">${studentData.contactInfo.isVerified ? 'Yes' : 'No'}</p>
                                </div>
                    `;
                }
                
                // Add additional fields if available
                if (studentData.dateOfBirth) {
                    detailsHTML += `
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Date of Birth</p>
                                    <p class="text-sm text-gray-900">${studentData.dateOfBirth}</p>
                                </div>
                    `;
                }
                
                if (studentData.rollNumber) {
                    detailsHTML += `
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Roll Number</p>
                                    <p class="text-sm text-gray-900">${studentData.rollNumber}</p>
                                </div>
                    `;
                }
                
                if (studentData.aggAttendance) {
                    detailsHTML += `
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Attendance</p>
                                    <p class="text-sm text-gray-900">${studentData.aggAttendance}</p>
                                </div>
                    `;
                }
                
                // Close the grid and add buttons
                detailsHTML += `
                            </div>
                        </div>
                        <div class="mt-6 flex justify-between">
                            <button id="start-chat-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">
                                Start Chat
                            </button>
                            <button id="close-details-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                modalContainer.innerHTML = detailsHTML;
                document.body.appendChild(modalContainer);
                
                // Add event listeners
                document.getElementById('close-details-modal').addEventListener('click', () => {
                    document.body.removeChild(modalContainer);
                });
                
                document.getElementById('close-details-btn').addEventListener('click', () => {
                    document.body.removeChild(modalContainer);
                });
                
                document.getElementById('start-chat-btn').addEventListener('click', () => {
                    document.body.removeChild(modalContainer);
                    openChat(regNo, studentData.studentName || `User ${regNo}`);
                });
                
                // Close on click outside
                modalContainer.addEventListener('click', (e) => {
                    if (e.target === modalContainer) {
                        document.body.removeChild(modalContainer);
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching student details:', error);
            });
        }
            
            // Display search results
            function displaySearchResults(results) {
                const container = document.getElementById('search-results');
                container.innerHTML = '';
                
                if (results.length === 0) {
                    container.innerHTML = `
                        <div class="p-4 text-center text-gray-500">
                            No users found. Try a different search term.
                        </div>
                    `;
                    return;
                }
                
                results.forEach(user => {
                    // Don't show current user in search results
                    if (user.regNo === currentUser.regNo) return;
                    
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.innerHTML = `
                        <div class="flex items-center">
                            <div class="bg-indigo-100 h-10 w-10 rounded-full flex items-center justify-center text-indigo-600 font-bold mr-3">
                                ${getInitials(user.studentName)}
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">${user.studentName}</h4>
                                <p class="text-xs text-gray-500">${user.regNo} · ${user.program}</p>
                            </div>
                        </div>
                    `;
                    
                    // Add click event to start chat
                    resultItem.addEventListener('click', function() {
                        openChat(user.regNo, user.studentName);
                    });
                    
                    container.appendChild(resultItem);
                });
            }
            
            // Open chat with a user
            function openChat(regNo, name) {
                activeChat = {
                    regNo: regNo,
                    name: name
                };
                
                // Update UI
                document.getElementById('conversation-list').classList.add('hidden');
                document.getElementById('active-chat').classList.remove('hidden');
                document.getElementById('compose-button-container').classList.add('hidden');
                backBtn.classList.remove('hidden');
                
                // Set chat header
                document.getElementById('chat-avatar').textContent = getInitials(name);
                document.getElementById('chat-name').textContent = name;
                document.getElementById('chat-reg-no').textContent = regNo;
                
                // Load messages
                loadMessages(regNo);
            }
            
            // Load messages for a conversation
            function loadMessages(otherRegNo) {
                if (!currentUser) {
                    currentUser = getCurrentUser();
                    if (!currentUser) return;
                }
                
                // Add a loading indicator if there are no messages yet
                const container = document.getElementById('chat-messages');
                if (container.children.length === 0) {
                    container.innerHTML = `
                        <div class="flex justify-center p-4">
                            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-500"></div>
                        </div>
                    `;
                }
                
                fetch(`/api/get-messages?regNo=${currentUser.regNo}&otherRegNo=${otherRegNo}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Always display messages or empty state for new chats
                            displayMessages(data.messages || []);
                        } else {
                            // Show empty state if no messages
                            displayMessages([]);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading messages:', error);
                        // Show error message only if container is empty (showing loading indicator)
                        if (container.children.length === 1 && container.querySelector('.animate-spin')) {
                            container.innerHTML = `
                                <div class="flex flex-col items-center justify-center h-full py-10">
                                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                                        <i class="fas fa-exclamation-circle text-red-400 text-2xl"></i>
                                    </div>
                                    <p class="text-sm text-red-500 text-center">Failed to load messages. Please try again.</p>
                                </div>
                            `;
                        }
                    });
            }
            
            // Display messages
            function displayMessages(messages) {
                const container = document.getElementById('chat-messages');
                
                // Clear any existing content (including loading animation)
                container.innerHTML = '';
                
                if (!messages || messages.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full py-10">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                <i class="fas fa-comments text-gray-300 text-2xl"></i>
                            </div>
                            <p class="text-sm text-gray-500 text-center">No messages yet. Start the conversation!</p>
                            <p class="text-xs text-gray-400 mt-2">Type a message below to begin chatting</p>
                        </div>
                    `;
                    return;
                }
                
                let lastDate = '';
                
                messages.forEach(message => {
                    const isSent = message.sender === currentUser.regNo;
                    const timestamp = new Date(message.timestamp * 1000);
                    const messageDate = formatDate(timestamp);
                    const messageTime = formatTime(timestamp);
                    
                    // Add date separator if date changes
                    if (messageDate !== lastDate) {
                        const dateSeparator = document.createElement('div');
                        dateSeparator.className = 'flex items-center justify-center my-4';
                        dateSeparator.innerHTML = `
                            <div class="bg-gray-200 text-gray-500 text-xs px-3 py-1 rounded-full">
                                ${messageDate}
                            </div>
                        `;
                        container.appendChild(dateSeparator);
                        lastDate = messageDate;
                    }
                    
                    const messageElement = document.createElement('div');
                    messageElement.className = `message-bubble ${isSent ? 'message-sent' : 'message-received'}`;
                    messageElement.dataset.messageId = message.id; // Add message ID as data attribute
                    messageElement.innerHTML = `
                        <div>${message.text}</div>
                        <div class="message-time">${messageTime}</div>
                    `;
                    
                    container.appendChild(messageElement);
                });
                
                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            }
            
            // Send a message
            function sendMessage() {
                if (!currentUser || !activeChat) return;
                
                const text = messageInput.value.trim();
                if (!text) return;
                
                // Clear input
                messageInput.value = '';
                
                // Create optimistic message (show immediately before server confirms)
                const optimisticMessageId = 'temp-' + Date.now();
                const timestamp = Math.floor(Date.now() / 1000);
                
                // Add optimistic message to chat
                const container = document.getElementById('chat-messages');
                const messageElement = document.createElement('div');
                messageElement.className = 'message-bubble message-sent';
                messageElement.dataset.messageId = optimisticMessageId;
                messageElement.innerHTML = `
                    <div>${text}</div>
                    <div class="message-time">Sending...</div>
                `;
                container.appendChild(messageElement);
                
                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
                
                // Send message to server
                fetch('/api/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sender: currentUser.regNo,
                        recipient: activeChat.regNo,
                        text: text
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the optimistic message with the real ID and time
                        const sentMessage = data.message;
                        const optimisticElement = document.querySelector(`[data-message-id="${optimisticMessageId}"]`);
                        
                        if (optimisticElement) {
                            optimisticElement.dataset.messageId = sentMessage.id;
                            const messageTime = formatTime(new Date(sentMessage.timestamp * 1000));
                            optimisticElement.querySelector('.message-time').textContent = messageTime;
                        } else {
                            // If optimistic message is not found, reload messages
                            loadMessages(activeChat.regNo);
                        }
                        
                        // Force immediate refresh of conversations
                        fetch(`/api/get-conversations?regNo=${currentUser.regNo}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success && data.conversations) {
                                    conversations = data.conversations;
                                    displayConversations(conversations);
                                    updateUnreadCount();
                                }
                            })
                            .catch(error => console.error('Error refreshing conversations:', error));
                        
                        // Update conversations in the background without full UI refresh
                        checkForNewMessages();
                    } else {
                        // If sending failed, mark the message as failed
                        const optimisticElement = document.querySelector(`[data-message-id="${optimisticMessageId}"]`);
                        if (optimisticElement) {
                            optimisticElement.classList.add('message-error');
                            optimisticElement.querySelector('.message-time').textContent = 'Failed to send';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    
                    // Mark the message as failed
                    const optimisticElement = document.querySelector(`[data-message-id="${optimisticMessageId}"]`);
                    if (optimisticElement) {
                        optimisticElement.classList.add('message-error');
                        optimisticElement.querySelector('.message-time').textContent = 'Failed to send';
                    }
                });
            }
            
            // Delete conversation
            function deleteConversation(otherRegNo) {
                if (!currentUser) return;
                
                fetch(`/api/delete-conversation?regNo=${currentUser.regNo}&otherRegNo=${otherRegNo}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Go back to conversation list
                        showConversationList();
                        
                        // Reload conversations
                        loadConversations();
                    }
                })
                .catch(error => {
                    console.error('Error deleting conversation:', error);
                    alert('Failed to delete conversation. Please try again.');
                });
            }
            
            // Show conversation list
            function showConversationList() {
                document.getElementById('conversation-list').classList.remove('hidden');
                document.getElementById('active-chat').classList.add('hidden');
                document.getElementById('search-results').classList.add('hidden');
                document.getElementById('compose-button-container').classList.remove('hidden');
                backBtn.classList.add('hidden');
                
                // Reset active chat
                activeChat = null;
                
                // Load conversations
                loadConversations();
            }
            
            // Update unread count
            function updateUnreadCount() {
                const unreadCount = conversations.reduce((total, conv) => total + conv.unread_count, 0);
                document.getElementById('unread-count').textContent = unreadCount;
            }
            
            // Start polling for new messages
            function startPolling() {
                // Clear any existing polling interval
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }
                
                // Poll every 10 seconds instead of 5 seconds
                pollingInterval = setInterval(() => {
                    if (currentUser) {
                        // Check for new messages without full UI refresh
                        checkForNewMessages();
                    }
                }, 10000); // Increased from 5000 to 10000 ms
            }
            
            // Check for new messages without full refresh
            function checkForNewMessages() {
                fetch(`/api/get-conversations?regNo=${currentUser.regNo}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.conversations) {
                            // Only update if there are changes
                            const hasNewMessages = hasConversationsChanged(conversations, data.conversations);
                            
                            if (hasNewMessages) {
                                conversations = data.conversations;
                                
                                // Always update the conversations container to ensure new chats appear
                                displayConversations(conversations);
                                
                                // Update unread count regardless
                                updateUnreadCount();
                                
                                // If in a chat, check if there are new messages for this conversation
                                if (activeChat) {
                                    const activeConversation = conversations.find(conv => conv.other_user === activeChat.regNo);
                                    if (activeConversation && activeConversation.unread_count > 0) {
                                        // Only reload messages if there are unread messages
                                        loadMessages(activeChat.regNo);
                                    }
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error checking for new messages:', error);
                        // Don't do anything on error to avoid disrupting the user
                    });
            }
            
            // Helper function to check if conversations have changed
            function hasConversationsChanged(oldConversations, newConversations) {
                // Different number of conversations
                if (oldConversations.length !== newConversations.length) {
                    return true;
                }
                
                // Check if there are new unread messages
                for (const newConv of newConversations) {
                    const oldConv = oldConversations.find(c => c.other_user === newConv.other_user);
                    
                    // New conversation or unread count changed
                    if (!oldConv || oldConv.unread_count !== newConv.unread_count) {
                        return true;
                    }
                    
                    // Latest message changed
                    if (oldConv.latest_message.id !== newConv.latest_message.id) {
                        return true;
                    }
                }
                
                return false;
            }
            
            // Helper function to get initials from name
            function getInitials(name) {
                if (!name || name === 'Unknown') return '?';
                
                const words = name.split(' ');
                if (words.length === 1) {
                    return words[0].charAt(0).toUpperCase();
                } else {
                    return (words[0].charAt(0) + words[words.length - 1].charAt(0)).toUpperCase();
                }
            }
            
            // Helper function to format timestamp
            function formatTimestamp(timestamp) {
                const date = new Date(timestamp * 1000);
                const now = new Date();
                const diff = (now - date) / 1000; // difference in seconds
                
                if (diff < 60) {
                    return 'Just now';
                } else if (diff < 3600) {
                    const minutes = Math.floor(diff / 60);
                    return `${minutes}m ago`;
                } else if (diff < 86400) {
                    const hours = Math.floor(diff / 3600);
                    return `${hours}h ago`;
                } else if (diff < 604800) {
                    const days = Math.floor(diff / 86400);
                    return `${days}d ago`;
                } else {
                    return formatDate(date);
                }
            }
            
            // Helper function to format date
            function formatDate(date) {
                const options = { month: 'short', day: 'numeric' };
                if (date.getFullYear() !== new Date().getFullYear()) {
                    options.year = 'numeric';
                }
                return date.toLocaleDateString('en-US', options);
            }
            
            // Helper function to format time
            function formatTime(date) {
                return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            }
            
            // Debounce function to limit API calls
            function debounce(func, wait) {
                let timeout;
                return function() {
                    const context = this;
                    const args = arguments;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        func.apply(context, args);
                    }, wait);
                };
            }
            
            // Initial load
            if (currentUser) {
                loadConversations();
            }
        }

        // Check for registration number pattern in message input
        messageInput.addEventListener('input', debounce(function() {
            const text = messageInput.value.trim();
            
            // Check if the text looks like a registration number (8 digits)
            const regNoMatch = text.match(/\b\d{8}\b/);
            
            if (regNoMatch) {
                const regNo = regNoMatch[0];
                
                // Show a suggestion to view student details
                if (!document.getElementById('view-details-suggestion')) {
                    const suggestionEl = document.createElement('div');
                    suggestionEl.id = 'view-details-suggestion';
                    suggestionEl.className = 'bg-indigo-50 p-2 text-sm text-indigo-700 rounded-md mt-2 flex items-center justify-between';
                    suggestionEl.innerHTML = `
                        <span>Registration number detected: ${regNo}</span>
                        <button class="px-2 py-1 bg-indigo-600 text-white text-xs rounded hover:bg-indigo-700 transition-colors">
                            View Details
                        </button>
                    `;
                    
                    // Insert after message input
                    messageInput.parentNode.insertAdjacentElement('afterend', suggestionEl);
                    
                    // Add click event to view details button
                    suggestionEl.querySelector('button').addEventListener('click', function() {
                        showStudentDetails(regNo);
                        // Remove the suggestion
                        if (document.getElementById('view-details-suggestion')) {
                            document.getElementById('view-details-suggestion').remove();
                        }
                    });
                }
            } else {
                // Remove suggestion if no registration number is found
                if (document.getElementById('view-details-suggestion')) {
                    document.getElementById('view-details-suggestion').remove();
                }
            }
        }, 300));

                    // TGPA Graph and Analysis
            let chartInstances = {
                tgpa: null,
                ca: null,
                midterm: null,
                endtermTheory: null,
                endtermPractical: null
            };

            // Render TGPA graph and analysis
            renderAnalysisCharts(data.termData, data.term_wise_marks);

            // Toggle graph visibility
            const toggleGraphBtn = document.getElementById('toggleGraphBtn');
            const tgpaGraphContainer = document.getElementById('tgpaGraphContainer');

            toggleGraphBtn.addEventListener('click', () => {
                if (tgpaGraphContainer.style.display === 'none') {
                    tgpaGraphContainer.style.display = 'block';
                    toggleGraphBtn.textContent = 'Hide Analysis';
                    
                    // Force chart resize to render properly
                    Object.values(chartInstances).forEach(chart => {
                        if (chart) chart.resize();
                    });
                } else {
                    tgpaGraphContainer.style.display = 'none';
                    toggleGraphBtn.textContent = 'Graphical Analysis';
                }
            });
            
            // Setup tab switching
            document.querySelectorAll('#chartTabs button').forEach(button => {
                button.addEventListener('click', () => {
                    // Hide all tab contents
                    document.querySelectorAll('#chartTabContent > div').forEach(div => {
                        div.classList.add('hidden');
                        div.classList.remove('block');
                    });
                    
                    // Show selected tab content
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(tabId).classList.remove('hidden');
                    document.getElementById(tabId).classList.add('block');
                    
                    // Update active tab styling
                    document.querySelectorAll('#chartTabs button').forEach(btn => {
                        btn.classList.remove('border-indigo-600');
                        btn.classList.add('border-transparent');
                        btn.setAttribute('aria-selected', 'false');
                    });
                    button.classList.remove('border-transparent');
                    button.classList.add('border-indigo-600');
                    button.setAttribute('aria-selected', 'true');
                    
                    // Resize the chart to fit container
                    const chartId = tabId.replace('-chart', '');
                    if (chartInstances[chartId]) {
                        chartInstances[chartId].resize();
                    }
                });
            });

                    function renderAnalysisCharts(termData, termWiseMarks) {
                // Prepare data for charts
                const labels = termData.map(term => `Term ${term.termId}`);
                const tgpas = termData.map(term => parseFloat(term.tgpa));
                
                // TGPA Chart
                const tgpaCtx = document.getElementById('tgpaChart').getContext('2d');
                chartInstances.tgpa = new Chart(tgpaCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'TGPA per Term',
                            data: tgpas,
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.2)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Term-wise TGPA Progress'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10, // Assuming TGPA is out of 10
                                title: {
                                    display: true,
                                    text: 'TGPA'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Term'
                                }
                            }
                        }
                    }
                });
                
                // Extract assessment data from term_wise_marks if available
                if (termWiseMarks && termWiseMarks.length > 0) {
                    // Prepare data structures for other charts
                    const caData = prepareAssessmentData(termWiseMarks, ['Continuous Assessment', 'CA', 'Assignment']);
                    const midtermData = prepareAssessmentData(termWiseMarks, ['Midterm', 'Mid Term', 'Mid-Term']);
                    const endtermTheoryData = prepareAssessmentData(termWiseMarks, ['End Term Theory', 'End-Term Theory', 'Final Theory']);
                    const endtermPracticalData = prepareAssessmentData(termWiseMarks, ['End Term Practical', 'End-Term Practical', 'Final Practical', 'Lab']);
                    
                    // Render other charts
                    renderAssessmentChart('caChart', 'Continuous Assessment Marks', caData);
                    renderAssessmentChart('midtermChart', 'Midterm Marks', midtermData);
                    renderAssessmentChart('endtermTheoryChart', 'End Term Theory Marks', endtermTheoryData);
                    renderAssessmentChart('endtermPracticalChart', 'End Term Practical Marks', endtermPracticalData);
                    
                    // Populate term details accordion
                    populateTermDetails(termWiseMarks);
                }
            }
            
            function prepareAssessmentData(termWiseMarks, componentTypes) {
                const termData = {};
                
                // Process each term
                termWiseMarks.forEach(term => {
                    const termId = term.term_id;
                    if (!termData[termId]) {
                        termData[termId] = {
                            totalObtained: 0,
                            totalMax: 0,
                            courses: []
                        };
                    }
                    
                    // Process each course in the term
                    term.courses.forEach(course => {
                        const courseData = {
                            name: course.course_name,
                            components: []
                        };
                        
                        // Find matching components
                        course.components.forEach(component => {
                            const componentTypeLower = component.type.toLowerCase();
                            const matchesType = componentTypes.some(type => 
                                componentTypeLower.includes(type.toLowerCase())
                            );
                            
                            if (matchesType) {
                                // Extract marks (e.g., "8/10")
                                const marksMatch = /(\d+)\/(\d+)/.exec(component.marks);
                                if (marksMatch && marksMatch.length >= 3) {
                                    const obtained = parseInt(marksMatch[1]);
                                    const total = parseInt(marksMatch[2]);
                                    
                                    if (!isNaN(obtained) && !isNaN(total)) {
                                        courseData.components.push({
                                            type: component.type,
                                            obtained: obtained,
                                            total: total,
                                            percentage: (obtained / total) * 100
                                        });
                                        
                                        termData[termId].totalObtained += obtained;
                                        termData[termId].totalMax += total;
                                    }
                                }
                            }
                        });
                        
                        if (courseData.components.length > 0) {
                            termData[termId].courses.push(courseData);
                        }
                    });
                });
                
                // Calculate percentages for each term
                const result = [];
                Object.keys(termData).forEach(termId => {
                    const term = termData[termId];
                    const percentage = term.totalMax > 0 ? 
                        (term.totalObtained / term.totalMax) * 100 : 0;
                    
                    result.push({
                        termId: termId,
                        percentage: percentage.toFixed(1),
                        totalObtained: term.totalObtained,
                        totalMax: term.totalMax,
                        courses: term.courses
                    });
                });
                
                // Sort by term ID
                result.sort((a, b) => parseInt(a.termId) - parseInt(b.termId));
                return result;
            }
            
            function renderAssessmentChart(canvasId, title, assessmentData) {
                if (!assessmentData || assessmentData.length === 0) {
                    // Display "No data available" message
                    const canvas = document.getElementById(canvasId);
                    const container = canvas.parentNode;
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-64">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                <i class="fa-duotone fa-thin fa-chart-simple text-gray-300 text-2xl"></i>
                            </div>
                            <p class="text-gray-500">No ${title.toLowerCase()} data available</p>
                        </div>
                    `;
                    return;
                }
                
                const ctx = document.getElementById(canvasId).getContext('2d');
                const chartType = canvasId.replace('Chart', '');
                
                const labels = assessmentData.map(term => `Term ${term.termId}`);
                const percentages = assessmentData.map(term => parseFloat(term.percentage));
                
                chartInstances[chartType] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: title,
                            data: percentages,
                            backgroundColor: 'rgba(99, 102, 241, 0.7)',
                            borderColor: '#6366f1',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: title
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const term = assessmentData[context.dataIndex];
                                        return [
                                            `Percentage: ${term.percentage}%`,
                                            `Marks: ${term.totalObtained}/${term.totalMax}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Percentage (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Term'
                                }
                            }
                        }
                    }
                });
            }
            
            function populateTermDetails(termWiseMarks) {
                const accordionContainer = document.getElementById('termDetailsAccordion');
                accordionContainer.innerHTML = '';
                
                if (!termWiseMarks || termWiseMarks.length === 0) {
                    accordionContainer.innerHTML = `
                        <div class="text-center py-6">
                            <p class="text-gray-500">No term details available</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort terms by ID
                const sortedTerms = [...termWiseMarks].sort((a, b) => 
                    parseInt(a.term_id) - parseInt(b.term_id)
                );
                
                sortedTerms.forEach((term, index) => {
                    const termId = term.term_id;
                    const isFirst = index === 0;
                    
                    const termCard = document.createElement('div');
                    termCard.className = 'bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden';
                    
                    // Create header
                    const header = document.createElement('button');
                    header.className = 'w-full flex items-center justify-between px-6 py-4 text-left';
                    header.innerHTML = `
                        <h5 class="text-lg font-medium text-gray-900">Term ${termId}</h5>
                        <i class="fa-duotone fa-thin fa-chevron-down transform transition-transform duration-200 ${isFirst ? 'rotate-180' : ''}"></i>
                    `;
                    header.setAttribute('aria-expanded', isFirst ? 'true' : 'false');
                    header.setAttribute('aria-controls', `term-${termId}-content`);
                    
                    // Create content
                    const content = document.createElement('div');
                    content.id = `term-${termId}-content`;
                    content.className = `px-6 py-4 bg-gray-50 ${isFirst ? '' : 'hidden'}`;
                    
                    // Add courses
                    let coursesHTML = '';
                    term.courses.forEach(course => {
                        coursesHTML += `
                            <div class="mb-6 last:mb-0">
                                <h6 class="font-medium text-gray-800 mb-3">${course.course_name}</h6>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Component</th>
                                                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Marks</th>
                                                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Weightage</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                        `;
                        
                        course.components.forEach(component => {
                            // Parse marks to calculate percentage
                            let marksText = component.marks;
                            let percentage = '';
                            
                            // Try to extract obtained/total from the marks string (e.g., "5/5")
                            const marksMatch = /(\d+)\/(\d+)/.exec(marksText);
                            if (marksMatch && marksMatch.length >= 3) {
                                const obtained = parseInt(marksMatch[1]);
                                const total = parseInt(marksMatch[2]);
                                
                                if (!isNaN(obtained) && !isNaN(total) && total > 0) {
                                    const percentValue = (obtained / total) * 100;
                                    
                                    // Determine color based on percentage
                                    let percentColor = 'text-green-600';
                                    if (percentValue < 60) {
                                        percentColor = 'text-red-600';
                                    } else if (percentValue < 75) {
                                        percentColor = 'text-yellow-600';
                                    }
                                    
                                    percentage = `<span class="${percentColor} ml-2">(${percentValue.toFixed(0)}%)</span>`;
                                }
                            }
                            
                            coursesHTML += `
                                <tr>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${component.type}</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${component.marks} ${percentage}</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${component.weightage}</td>
                                </tr>
                            `;
                        });
                        
                        coursesHTML += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    });
                    
                    content.innerHTML = coursesHTML;
                    
                    // Toggle functionality
                    header.addEventListener('click', () => {
                        const isExpanded = header.getAttribute('aria-expanded') === 'true';
                        const icon = header.querySelector('i');
                        
                        if (isExpanded) {
                            content.classList.add('hidden');
                            icon.classList.remove('rotate-180');
                            header.setAttribute('aria-expanded', 'false');
                        } else {
                            content.classList.remove('hidden');
                            icon.classList.add('rotate-180');
                            header.setAttribute('aria-expanded', 'true');
                        }
                    });
                    
                    // Add to accordion
                    termCard.appendChild(header);
                    termCard.appendChild(content);
                    accordionContainer.appendChild(termCard);
                });
            }

        // Add this function after the existing script tag and before any other JavaScript code
        function scrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Find the existing message handling code and add scrollToBottom calls
        function appendMessage(message, isOutgoing = false) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isOutgoing ? 'justify-end' : 'justify-start'}`;
            
            messageDiv.innerHTML = `
                <div class="${isOutgoing ? 'bg-indigo-600 text-white' : 'bg-white'} rounded-lg px-4 py-2 max-w-[70%] shadow-sm">
                    <p class="text-sm">${message}</p>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom(); // Scroll to bottom after adding new message
        }

        // Modify the existing message sending code
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const message = this.value.trim();
                if (message) {
                    appendMessage(message, true);
                    this.value = '';
                    scrollToBottom(); // Scroll to bottom after sending message
                }
            }
        });

        document.getElementById('send-message').addEventListener('click', function() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            if (message) {
                appendMessage(message, true);
                messageInput.value = '';
                scrollToBottom(); // Scroll to bottom after sending message
            }
        });

        // Add this to scroll to bottom when chat is opened
        document.addEventListener('DOMContentLoaded', function() {
            scrollToBottom();
        });
    </script>
</body>
</html>